<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Printed Concrete - Universal Cost Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- html2canvas library for capturing DOM as image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Diperbarui: Menambahkan impor doc, getDoc, getDocs, deleteDoc

        // Firebase configuration and initialization (MANDATORY GLOBALS)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Log Firebase configuration and App ID for debugging purposes
        console.log("Firebase Config:", firebaseConfig);
        console.log("App ID:", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');

        let userId = 'anonymous'; // Default to anonymous
        let isAuthReady = false;

        // Sign in anonymously if no custom token, otherwise use custom token
        if (typeof __initial_auth_token !== 'undefined') {
            signInWithCustomToken(auth, __initial_auth_token)
                .then((userCredential) => {
                    userId = userCredential.user.uid;
                    isAuthReady = true;
                    console.log("Signed in with custom token. User ID:", userId);
                    window.dispatchEvent(new CustomEvent('authReady')); // Dispatch event
                })
                .catch((error) => {
                    console.error("Error signing in with custom token:", error);
                    signInAnonymously(auth).then((userCredential) => {
                        userId = userCredential.user.uid;
                        isAuthReady = true;
                        console.log("Signed in anonymously due to custom token error. User ID:", userId);
                        window.dispatchEvent(new CustomEvent('authReady')); // Dispatch event
                    });
                });
        } else {
            signInAnonymously(auth)
                .then((userCredential) => {
                    userId = userCredential.user.uid; // Akses UID dari userCredential.user
                    isAuthReady = true;
                    console.log("Signed in anonymously. User ID:", userId);
                    window.dispatchEvent(new CustomEvent('authReady')); // Dispatch event
                })
                .catch((error) => {
                    console.error("Error signing in anonymously:", error);
                });
        }

        // Make db, auth, userId, isAuthReady globally accessible (or via a pattern like context)
        // For simplicity in this single HTML file, we can attach to window for functions to use.
        window.db = db;
        window.auth = auth;
        window.getUserId = () => userId;
        window.isAuthReady = () => isAuthReady;
        window.serverTimestamp = serverTimestamp; // Expose serverTimestamp
        // Diperbarui: Mengekspos fungsi-fungsi modular Firestore
        window.collection = collection;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
        window.addDoc = addDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.deleteDoc = deleteDoc;


        // Add a listener for auth state changes (important for real apps)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
            } else {
                // User is signed out.
                userId = 'anonymous';
                isAuthReady = false;
            }
            console.log("Auth state changed. Current User ID:", userId);
            // Optionally re-render or re-fetch data based on auth state
            // If the initial setup handles data fetching on authReady, this might not be strictly needed for re-auth
        });

    </script>
    <style>
        /* Modern and Professional Styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif; /* Changed font to Inter */
            background-color: #EAEFF5; /* Lighter, more professional background */
            min-height: 100vh;
            padding: 20px;
            padding-top: 84px; /* Adjusted padding-top for fixed navigation bar */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            scroll-behavior: smooth; /* Smooth scrolling for anchor links */
        }
        @media (max-width: 768px) {
            body {
                padding-top: 76px; /* Adjust body padding for smaller nav on mobile */
            }
        }
        
        .container {
            max-width: 1400px;
            width: 100%; /* Ensure it takes full width within padding */
            margin: 0 auto;
        }
        
        /* Navigation Bar Styles */
        .nav-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 64px; /* Fixed height for nav */
            background-color: rgba(30, 41, 59, 0.8); /* Dark slate with transparency */
            backdrop-filter: blur(5px); /* Blur effect for transparency */
            z-index: 1000; /* Ensure nav is on top */
            overflow-y: hidden; /* Prevent vertical scrolling on nav itself */
            overflow-x: auto; /* Enable horizontal scrolling if content exceeds width */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            transition: height 0.3s ease-in-out; /* Smooth transition for height changes */
            display: flex; /* Use flex to align icon and text */
            align-items: center; /* Vertically center nav links */
            justify-content: center; /* Horizontally center nav links */
            padding: 0 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for depth */
        }

        @media (max-width: 768px) {
            .nav-container {
                height: 56px; /* Slightly smaller height on mobile */
            }
        }

        /* Hide scrollbar for nav-container on Webkit browsers */
        .nav-container::-webkit-scrollbar {
            display: none;
        }
        .nav-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .nav-links {
            display: flex;
            height: 100%; /* Ensure links take full height for vertical centering */
            white-space: nowrap; /* Prevent links from wrapping */
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            margin: 0 0.25rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
            color: white; /* Text color for nav items */
            text-decoration: none; /* Remove underline from links */
            font-weight: 600;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .nav-item:active {
            transform: translateY(0);
        }
        /* End Navigation Bar Styles */

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: #FFFFFF; /* Solid white background */
            padding: 30px;
            border-radius: 12px; /* Slightly less rounded */
            box-shadow: 0 8px 24px rgba(0,0,0,0.08); /* Softer shadow */
        }
        
        .header h1 {
            color: #2C3E50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4A90E2, #6A5ACD); /* Professional blue gradient */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex; /* Use flex to align icon and text */
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .header h1 .icon {
            font-size: 1.2em;
            -webkit-text-fill-color: #4A90E2;
        }
        
        .company-info {
            color: #666666;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .project-input, .section {
            background: #FFFFFF;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .project-input:hover, .section:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .project-input h3, .section-header {
            color: #333333;
            margin-bottom: 20px;
            font-size: 1.3em;
            font-weight: 600;
            display: flex; /* Use flex to align title and toggle button */
            justify-content: space-between;
            align-items: center;
        }
        
        .section-header {
            background: #4A90E2;
            color: white;
            padding: 18px 25px;
            border-radius: 12px 12px 0 0;
            margin: -25px -25px 20px -25px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-header .toggle-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
            transition: transform 0.2s ease;
        }
        .section-header .toggle-button:hover {
            transform: scale(1.1);
        }
        .section-header .toggle-button.collapsed {
            transform: rotate(-90deg);
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .input-group label {
            color: #333333;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .input-group input, .input-group select {
            padding: 12px;
            border: 1px solid #D1D9E0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
            color: #333333;
            background-color: #FDFDFD;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2);
            background-color: #FFFFFF;
        }
        
        .printer-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .printer-card {
            border: 1px solid #D1D9E0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            background-color: #F8F9FA;
            box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        }
        
        .printer-card:hover {
            border-color: #4A90E2;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(74, 144, 226, 0.15);
        }
        
        .printer-card.selected {
            border-color: #4A90E2;
            background-color: #E6F0FA;
            box-shadow: 0 8px 16px rgba(74, 144, 226, 0.25);
        }

        .printer-card.selected::after {
            content: '‚úîÔ∏è';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
            color: #4A90E2;
        }
        
        .printer-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #333333;
            margin-bottom: 15px;
        }
        
        .pricing-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .pricing-option {
            text-align: center;
            padding: 12px;
            border: 1px solid #E0E6ED;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            background-color: #FFFFFF;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        
        .pricing-option:hover {
            background-color: #F0F4F8;
            box-shadow: 0 4px 8px rgba(0,0,0,0.06);
        }
        
        .pricing-option.selected {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
        }

        .pricing-option.selected::after {
            content: '‚úîÔ∏è';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.0em;
            color: white;
        }
        
        .price-amount {
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .price-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #E0E6ED;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background-color: #FFFFFF;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E0E6ED;
        }
        
        th {
            background-color: #F8F9FA;
            color: #333333;
            font-weight: 600;
        }
        
        tr:last-child td {
            border-bottom: none;
        }

        .editable {
            background-color: #FFFCEE;
            border: 1px solid #FFEDC2;
            padding: 8px;
            border-radius: 5px;
            width: 100%;
            /* Increased max-width for better display of larger numbers */
            max-width: 140px; /* Adjusted from 100px */
            /* Align numeric inputs to the right for better readability */
            text-align: right; /* Changed from center */
            color: #6C5400;
            transition: all 0.2s ease-in-out;
        }

        .editable:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.2);
            background-color: #FFFFFF;
        }
        
        .calculated {
            background-color: #EBF8E8;
            color: #1A7036;
            font-weight: 600;
            padding: 8px;
            border-radius: 5px;
        }
        
        .total-row {
            background-color: #F0F4FA;
            font-weight: bold;
        }
        
        .summary-section .section-header {
            background: #6A5ACD;
        }

        .summary-section table {
            table-layout: fixed;
            width: 100%;
        }

        /* Adjusted column widths for summary table after removing "Cost per m¬≥" */
        .summary-section table th:nth-child(1) { width: 25%; } /* Category */
        .summary-section table th:nth-child(2) { width: 40%; } /* Description */
        .summary-section table th:nth-child(3) { width: 20%; } /* Total Project */
        .summary-section table th:nth-child(4) { width: 15%; } /* Percentage */


        .summary-section table th,
        .summary-section table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E0E6ED;
        }

        .summary-section table th {
            background-color: #7E74D4;
            color: white;
        }

        .summary-section tbody td {
            vertical-align: middle;
            text-align: right; /* Default to right for calculated values */
        }
        
        /* Specific alignment for description column */
        .summary-section tbody td:nth-child(2) { /* Apply directly to TD */
            text-align: left; /* Ensure description is left-aligned */
            white-space: normal; /* Allow text wrapping */
            overflow: visible; /* Ensure content is not hidden */
            text-overflow: clip; /* Prevent ellipsis */
        }
        
        /* Align percentage to right and make bold for calculated values */
        .summary-section td.calculated[id$="_percentage"] {
            font-weight: bold;
            text-align: right;
        }

        .summary-section .total-row td { /* Apply directly to TD */
            color: #1A202C;
        }
        
        .cost-per-cubic {
            background: linear-gradient(135deg, #1ABC9C, #2ECC71);
            color: white;
            padding: 25px;
            text-align: center;
            border-radius: 12px;
            margin: 20px 0;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
        }
        
        .cost-per-cubic h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .cost-per-cubic .amount {
            font-size: 3.2em;
            font-weight: bold;
            margin: 10px 0;
            letter-spacing: -1px;
        }
        
        .btn {
            background: linear-gradient(135deg, #4A90E2, #6A5ACD);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.3);
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.9em;
        }
        
        .alert-info {
            background: #E0F2F7;
            border: 1px solid #BEEBF9;
            color: #0A608F;
        }

        .disabled-row {
            opacity: 0.6;
            background-color: #f5f5f5;
        }

        .disabled-row input[type="number"],
        .disabled-row select {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }
        
        .use-checkbox {
            margin-left: 10px;
            transform: scale(1.2);
            cursor: pointer;
            vertical-align: middle;
        }

        /* Styles from rebar_calculation.html for rebar section */
        .rebar-section {
            background: #FFFFFF;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }
        .rebar-section .section-header {
            background: #E63946; /* A distinct color for rebar section */
        }
        .rebar-section .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .rebar-section .summary-card {
            background: linear-gradient(135deg, #FF6B6B, #E63946); /* Reddish gradient */
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(230, 57, 70, 0.3);
        }
        .rebar-section .summary-card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        .rebar-section .summary-card .value {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .rebar-section .calculation-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .rebar-section .calculation-table th {
            background: linear-gradient(45deg, #C0392B, #E74C3C); /* Darker red for table header */
            color: white;
            padding: 18px 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }
        .rebar-section .calculation-table td {
            padding: 15px 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
            font-size: 1.05em;
        }
        .rebar-section .calculation-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .rebar-section .calculation-table tr:hover {
            background-color: #FDE8E8; /* Lighter red on hover */
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
        .rebar-section .price-section {
            background: linear-gradient(135deg, #fd7e14, #e63946);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .rebar-section .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .rebar-section .price-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        .rebar-section .notes {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeeba;
            border-radius: 15px;
            padding: 25px;
            margin-top: 30px;
        }
        .rebar-section .notes h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        .rebar-section .notes ul {
            color: #856404;
            margin-left: 20px;
        }
        .rebar-section .notes li {
            margin-bottom: 8px;
            line-height: 1.5;
        }


        @media print {
            body {
                background-color: #fff;
                padding: 0;
                margin: 0;
                font-family: 'Inter', sans-serif;
            }
            .container {
                box-shadow: none;
                max-width: 100%;
            }
            .header, .project-input, .section, .cost-per-cubic, .rebar-section {
                box-shadow: none;
                border-radius: 0;
                margin-bottom: 10px;
                padding: 10px;
            }
            .header h1 {
                -webkit-print-color-adjust: exact;
                color: #2C3E50;
                font-size: 2em;
                gap: 5px;
            }
            .section-header {
                -webkit-print-color-adjust: exact;
                background: #4A90E2 !important;
                color: white !important;
                border-radius: 0;
                margin: -10px -10px 10px -10px;
                padding: 10px;
                font-size: 1.1em;
                gap: 5px;
            }
            .rebar-section .section-header {
                background: #E63946 !important;
            }
            /* Now display all inputs, checkboxes, and alerts in print mode */
            .print-button, .export-button, .nav-container { /* Keep print/export buttons and nav hidden */
                display: none !important;
            }
            /* Hide the donation section for print */
            .donation-section {
                display: none !important;
            }

            /* Remove overrides that hide/change appearance of inputs/checkboxes */
            .input-group input:not([type="checkbox"]),
            .input-group select,
            .use-checkbox,
            .alert {
                display: block !important; /* Ensure they are visible */
                /* Optionally reset any specific print-only styling that was hiding them */
                background-color: initial !important;
                border: initial !important;
                color: initial !important;
                box-shadow: initial !important;
                text-align: initial !important;
                width: initial !important;
                max-width: initial !important;
                padding: initial !important;
            }
            /* Specific adjustment for readonly inputs if needed for styling */
            .input-group input[readonly] {
                /* Can leave these to original styling or adjust if needed */
                background-color: #f0f0f0 !important; /* Example: light grey for readonly */
                border: 1px solid #ccc !important;
                padding: 4px !important;
                border-radius: 4px !important;
            }

            .input-group label {
                font-weight: bold;
                color: #000;
                display: block !important;
                margin-bottom: 0px !important;
            }
            
            .calculated {
                display: block !important;
                /* Reset calculated field styling to make it visible and distinct */
                background-color: #EBF8E8 !important;
                color: #1A7036 !important;
                font-weight: 600 !important;
                padding: 8px !important;
                border-radius: 5px !important;
                border: 1px solid #D1D9E0 !important; /* Add border for consistency */
                text-align: right !important;
                width: auto !important;
                max-width: none !important;
                padding: initial !important;
            }

            table {
                break-inside: avoid;
                page-break-inside: avoid;
                width: 100%;
            }
            table tr {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .section, .rebar-section {
                page-break-inside: avoid !important;
                page-break-before: auto !important;
                break-inside: avoid !important;
            }

            th, td {
                border-color: #ccc !important;
                padding: 8px !important;
                vertical-align: top !important;
                color: #000 !important;
            }

            .summary-section table th {
                text-align: center !important;
                background-color: #7E74D4 !important;
                color: white !important;
            }

            /* Adjusted column widths for better alignment in print */
            .summary-section table th:nth-child(1) { width: 25% !important; text-align: left !important; } /* Category */
            .summary-section table th:nth-child(2) { 
                width: 40% !important; /* Adjusted for more space for numbers */
                text-align: left !important; 
                white-space: normal !important; /* Allow text wrapping */
                overflow: visible !important; /* Ensure content is not hidden */
                text-overflow: clip !important; /* Prevent ellipsis */
            } /* Description */
            /* Removed Cost per m¬≥ column for print */
            .summary-section table th:nth-child(3) { width: 20% !important; text-align: right !important; } /* Total Project */
            .summary-section table th:nth-child(4) { width: 15% !important; text-align: right !important; } /* Percentage */

            /* Make font size smaller for the actual cost values in print mode */
            .summary-section tbody td:nth-child(3),
            .summary-section tbody td:nth-child(4) { /* Adjusted column index */
                font-size: 0.9em !important; /* Make numbers slightly smaller */
            }
            /* Hide USD currency span in print mode */
            .usd-currency {
                display: none !important;
            }


            #material_qty_summary_tbody th:nth-child(1),
            #material_qty_summary_tbody td:nth-child(1) {
                width: 40% !important;
                text-align: left !important;
            }
            #material_qty_summary_tbody th:nth-child(2),
            #material_qty_summary_tbody td:nth-child(2) {
                width: 30% !important;
                text-align: right !important;
            }
            #material_qty_summary_tbody th:nth-child(3),
            #material_qty_summary_tbody td:nth-child(3) {
                width: 30% !important;
                text-align: right !important;
            }

            .summary-section .total-row td {
                color: #000 !important;
                font-weight: bold !important;
            }

            .print-only-project-name {
                display: block !important;
                font-size: 1.5em;
                font-weight: bold;
                color: #000;
                margin-bottom: 10px;
                text-align: center;
            }
            .project-name-input-group {
                display: none !important;
            }
        }

        /* Styles for image export mode to mimic browser view */
        /* These styles will be applied temporarily to the body during html2canvas capture */
        body.export-mode .print-button,
        body.export-mode .export-button,
        body.export-mode .nav-container { /* Keep print/export buttons and nav hidden */
            display: none !important;
        }
        /* Hide the donation section for export mode */
        body.export-mode .donation-section {
            display: none !important;
        }

        /* Ensure all interactive elements and notes are visible in export mode */
        body.export-mode input,
        body.export-mode select,
        body.export-mode .use-checkbox,
        body.export-mode .alert {
            display: block !important;
            background-color: initial !important; /* Revert to browser styles */
            border: initial !important;
            color: initial !important;
            box-shadow: initial !important;
            text-align: initial !important;
            width: initial !important;
            max-width: initial !important;
            padding: initial !important;
        }

        /* Specific styles for elements that were hidden or overridden */
        body.export-mode .project-name-input-group {
            display: flex !important; /* Show the project name input group */
        }
        body.export-mode .print-only-project-name {
            display: none !important; /* Hide the print-only project name */
        }

        body.export-mode .input-group input[readonly],
        body.export-mode .calculated {
            /* Reset these to their default browser appearance */
            background-color: initial !important;
            border: initial !important;
            color: initial !important;
            box-shadow: initial !important;
            text-align: initial !important;
            width: initial !important;
            max-width: initial !important;
            padding: initial !important;
        }

        /* Ensure text in description cells wraps in export mode */
        body.export-mode .summary-section tbody td:nth-child(2) {
            white-space: normal !important; /* Allow text wrapping */
            overflow: visible !important; /* Ensure content is not hidden */
            text-overflow: clip !important; /* Prevent ellipsis */
        }

        /* Apply print-mode width and font-size adjustments to export-mode as well */
        body.export-mode .summary-section table th:nth-child(1),
        body.export-mode .summary-section table td:nth-child(1) { width: 25% !important; text-align: left !important; }
        body.export-mode .summary-section table th:nth-child(2),
        body.export-mode .summary-section table td:nth-child(2) { 
            width: 40% !important; 
            text-align: left !important; 
            white-space: normal !important; 
            overflow: visible !important; 
            text-overflow: clip !important; 
        }
        /* Removed Cost per m¬≥ column for export mode */
        body.export-mode .summary-section table th:nth-child(3),
        body.export-mode .summary-section table td:nth-child(3) { 
            width: 20% !important; 
            text-align: right !important; 
        }
        body.export-mode .summary-section table th:nth-child(4),
        body.export-mode .summary-section table td:nth-child(4) { 
            width: 15% !important; 
            text-align: right !important; 
        }
        body.export-mode .summary-section tbody td:nth-child(3),
        body.export-mode .summary-section tbody td:nth-child(4) { /* Adjusted column index */
            font-size: 0.9em !important; /* Make numbers slightly smaller */
        }
        /* Hide USD currency span in export mode */
        body.export-mode .usd-currency {
            display: none !important;
        }


        /* Continue with existing print/export layout adjustments for consistency */
        body.export-mode table,
        body.export-mode table tr,
        body.export-mode .section,
        body.export-mode .rebar-section {
            break-inside: avoid;
            page-break-inside: avoid;
        }
        body.export-mode th,
        body.export-mode td {
            border-color: #ccc !important;
            padding: 8px !important;
            vertical-align: top !important;
            color: #000 !important;
        }
        body.export-mode .summary-section table th {
            text-align: center !important;
            background-color: #7E74D4 !important;
            color: white !important;
        }
        body.export-mode #material_qty_summary_tbody th:nth-child(1),
        body.export-mode #material_qty_summary_tbody td:nth-child(1) {
            width: 40% !important;
            text-align: left !important;
        }
        body.export-mode #material_qty_summary_tbody th:nth-child(2),
        body.export-mode #material_qty_summary_tbody td:nth-child(2) {
            width: 30% !important;
            text-align: right !important;
        }
        body.export-mode #material_qty_summary_tbody th:nth-child(3),
        body.export-mode #material_qty_summary_tbody td:nth-child(3) {
            width: 30% !important;
            text-align: right !important;
        }
        body.export-mode .summary-section .total-row td {
            color: #000 !important;
            font-weight: bold !important;
        }
        /* Style for history table */
        #history_table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #history_table th, #history_table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        #history_table th {
            background-color: #f2f2f2;
            color: #333;
        }
        #user_id_display {
            font-weight: bold;
            color: #0056b3;
            margin-top: 10px;
            font-size: 0.9em;
            word-break: break-all; /* Allow breaking long IDs */
        }

    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="nav-container">
        <div class="nav-links">
            <a href="#project-parameters" class="nav-item">Parameters</a>
            <a href="#rebar" class="nav-item">Rebar</a>
            <a href="#raw-materials" class="nav-item">Materials</a>
            <a href="#equipment" class="nav-item">Equipment</a>
            <a href="#labor" class="nav-item">Labor</a>
            <a href="#cost-summary" class="nav-item">Summary</a>
            <a href="#history" class="nav-item">History</a> <!-- Added History to nav -->
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>3D Printed Concrete - Universal Cost Calculator</h1>
            <div class="company-info">
                Calculated Estimated & Should Include a 10-15% Margin<br>
                
            </div>
        </div>

        <div class="project-input" id="project-parameters">
            <h3 class="section-header">
                <span>üèóÔ∏è Project Parameters</span>
                <button class="toggle-button" onclick="toggleSection('project-parameters-content', this)">-</button>
            </h3>
            <div id="project-parameters-content" class="section-content">
                <div class="input-grid">
                    <div class="input-group project-name-input-group">
                        <label for="project_name">Project Name</label>
                        <input type="text" id="project_name" placeholder="Enter project name" value="" onkeyup="updateProjectNameForPrint()">
                    </div>
                    <span id="print_project_name" class="print-only-project-name" style="display: none;"></span>
                    <div class="input-group">
                        <label for="structure_type">Structure Type</label>
                        <select id="structure_type" onchange="calculateAll()">
                            <option value="wall">Wall</option>
                            <option value="column">Column</option>
                            <option value="beam">Beam</option>
                            <option value="slab">Slab</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <!-- New: Currency Selector -->
                    <div class="input-group">
                        <label for="currency_selector">Select Currency</label>
                        <select id="currency_selector" onchange="updateCurrency()">
                            <option value="IDR">Indonesian Rupiah (IDR)</option>
                            <option value="USD">United States Dollar (USD)</option>
                            <option value="CNY">Chinese Yuan (CNY)</option>
                            <option value="EUR">Euro (EUR)</option>
                            <option value="JPY">Japanese Yen (JPY)</option>
                            <option value="GBP">British Pound (GBP)</option>
                            <option value="AUD">Australian Dollar (AUD)</option>
                            <option value="CAD">Canadian Dollar (CAD)</option>
                            <option value="CHF">Swiss Franc (CHF)</option>
                        </select>
                    </div>
                    <!-- End New: Currency Selector -->
                </div>

                <div class="input-grid mt-4">
                    <div class="input-group">
                        <label for="length_mm">Length (mm)</label>
                        <input type="number" id="length_mm" value="0" step="10" onchange="calculateAll()" data-manual-control="true">
                    </div>
                    <div class="input-group">
                        <label for="width_mm">Width (mm)</label>
                        <input type="number" id="width_mm" value="0" step="10" onchange="calculateAll()" data-manual-control="true">
                    </div>
                    <div class="input-group">
                        <label for="height_mm">Height (mm)</label>
                        <input type="number" id="height_mm" value="0" step="10" onchange="calculateAll()" data-manual-control="true">
                    </div>
                </div>

                <div class="input-grid mt-4">
                    <div class="input-group">
                        <label for="total_volume">Total Volume (m¬≥)</label>
                        <input type="number" id="total_volume" value="0" step="0.001" onchange="updateVolumeSource()">
                        <div style="margin-top: 5px;">
                            <input type="checkbox" id="calc_volume_from_lwh" onchange="updateVolumeSource()"> <!-- Removed checked attribute -->
                            <label for="calc_volume_from_lwh" style="display: inline; font-weight: normal;">Calculate volume from L, W, H</label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="project_duration">Project Duration (days)</label>
                        <input type="number" id="project_duration" value="0" readonly> <!-- Changed initial value to 0 -->
                        <span class="text-xs text-gray-500" id="project_duration_hours_minutes"></span>
                    </div>
                    <div class="input-group">
                        <label for="printer_operating_hours_per_day">Printer Hours/Day</label>
                        <input type="number" id="printer_operating_hours_per_day" value="0" step="1" min="0" max="24" onchange="calculateAll()"> <!-- Changed initial value to 0 -->
                    </div>
                    <div class="input-group">
                        <label for="mixing_operating_hours_per_day">Mixing Hours/Day</label>
                        <input type="number" id="mixing_operating_hours_per_day" value="0" step="1" min="0" max="24" onchange="calculateAll()"> <!-- Changed initial value to 0 -->
                    </div>
                    <div class="input-group">
                        <label for="waste_percentage">Waste Percentage (%)</label>
                        <input type="number" class="editable" id="waste_percentage" value="0" step="1" min="0" max="100" onchange="calculateAll()">
                    </div>
                </div>

                <div class="input-grid mt-4">
                    <div class="input-group">
                        <label for="nozzle_width">Nozzle Width (mm)</label>
                        <input type="number" id="nozzle_width" value="0" step="1" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label for="nozzle_height">Nozzle Height (mm)</label>
                        <input type="number" id="nozzle_height" value="0" step="1" onchange="calculateAll()">
                    </div>
                </div>

                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>‚ÑπÔ∏è Note:</strong> Total Volume (m¬≥) can be calculated from Length, Width, and Height, or entered manually. Project Duration is automatically calculated based on Total Volume, Daily Operating Hours **for Printer** (assuming 0.3 m¬≥ material requires 1 hour for printing) AND **for Mixing** (assuming a 0.081 m¬≥ /batch).
                </div>
            </div>
        </div>

        <!-- Rebar Section (Moved) -->
        <div class="section" id="rebar">
            <h3 class="section-header">
                <span>üîß Sub Materials - Rebar (Integrated Calculation)</span>
                <button class="toggle-button" onclick="toggleSection('rebar-content', this)">-</button>
            </h3>
            <div id="rebar-content" class="section-content">
                <div class="input-grid">
                    <div class="input-group">
                        <label for="rebar_length_mm">Segment Length (L) (mm)</label>
                        <input type="number" id="rebar_length_mm" placeholder="Example: 8240" value="0" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label for="rebar_width_mm">Segment Width (W) (mm)</label>
                        <input type="number" id="rebar_width_mm" placeholder="Example: 1440" value="0" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label for="rebar_height_mm">Segment Height (H) (mm)</label>
                        <input type="number" id="rebar_height_mm" placeholder="Example: 170" value="0" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label for="rebar_segments">Number of Segments (units)</label>
                        <input type="number" id="rebar_segments" placeholder="Example: 6" value="0" min="0" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label for="rebar_price_per_kg">Rebar Price (IDR/kg)</label>
                        <input type="number" id="rebar_price_per_kg" placeholder="Example: 18000" value="0" onchange="calculateAll()">
                    </div>
                </div>
                
                <button class="btn" style="margin-top: 20px;" onclick="calculateAll()">
                    üßÆ Calculate Rebar Needs for Segments
                </button>

                <div class="rebar-section-results">
                    <div class="summary-cards" id="rebarSummaryCards">
                        <div class="summary-card">
                            <h3>Total Rebar Weight</h3>
                            <div class="value" id="rebar_total_weight_display">0 kg</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Rebar Length</h3>
                            <div class="value" id="rebar_total_length_display">0 m</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Rebar Cost</h3>
                            <div class="value" id="rebar_total_cost_display">Rp 0</div>
                        </div>
                        <div class="summary-card">
                            <h3>Total Bars (12m)</h3>
                            <div class="value" id="rebar_total_bars_display">0 bars</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 20px; color: #2c3e50;">üìä Rebar Calculation Details per Type</h4>
                    <div class="table-container">
                        <table class="calculation-table">
                            <thead>
                                <tr>
                                    <th>Joint Type</th>
                                    <th>Total Length (m)</th>
                                    <th>Diameter</th>
                                    <th>Number of Rows</th>
                                    <th>Overall Length (m)</th>
                                    <th>Weight (kg)</th>
                                </tr>
                            </thead>
                            <tbody id="rebarDetailTableBody">
                                <!-- Data will be filled by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <h4 style="margin-top: 20px; color: #2c3e50;">üí∞ Cost Breakdown per Rebar Diameter</h4>
                    <div class="price-section">
                        <div class="price-grid" id="rebarPriceGrid">
                            <!-- Price details will be filled by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="alert alert-info" style="margin-top: 20px;">
                        <strong>üí° Rebar Calculation Notes:</strong>
                        <ul>
                            <li>Calculation is based on the **specific segment dimensions and number of segments** you input in this section, for on-site assembly.</li>
                            <li>This calculation **does NOT automatically scale with the overall "Total Volume (m¬≥)"** of your project. If you manually adjust the project's "Total Volume" and need the rebar cost to reflect that scale, you must manually adjust the "Number of Segments" or other dimensions in this section.</li>
                            <li>Rebar is primarily for **segment joints** and tie structures.</li>
                            <li>Add **10% tolerance** for field adjustments.</li>
                            <li>Prepare **grooves/channels** on segments for rebar placement.</li>
                            <li>Ensure proper alignment before final grouting.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Section: Project Image Upload -->
        <div class="section" id="project-visualization">
            <h3 class="section-header">
                <span>üñºÔ∏è Project Visualization</span>
                <button class="toggle-button" onclick="toggleSection('project-visualization-content', this)">-</button>
            </h3>
            <div id="project-visualization-content" class="section-content">
                <div class="input-group" style="margin-bottom: 20px;">
                    <label for="project_image_upload">Upload Project Image:</label>
                    <input type="file" accept="image/*" id="project_image_upload" onchange="previewProjectImage(event)">
                    <small style="color: #666; margin-top: 5px;">Upload an image for project visualization (JPG, PNG, GIF).</small>
                </div>
                <div class="project-image-preview" style="text-align: center;">
                    <img id="project_preview_image" src="https://placehold.co/600x400/EAEFF5/666666?text=Project+Image" alt="Project Image Preview" style="max-width: 100%; height: auto; border-radius: 8px; margin-top: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: block;">
                </div>
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>‚ÑπÔ∏è Note:</strong> Uploaded images will appear here. For printed reports, this image will be included.
                </div>
            </div>
        </div>


        <!-- Detailed Printing Geometry Section -->
        <div class="section" id="printing-geometry">
            <h3 class="section-header">
                <span>üìê Detailed Printing Geometry (for Ink Cost & Volume Reference)</span>
                <button class="toggle-button" onclick="toggleSection('printing-geometry-content', this)">-</button>
            </h3>
            <div id="printing-geometry-content" class="section-content">
                <div class="input-grid">
                    <div class="input-group">
                        <label for="ink_width_mm">Ink Width (mm)</label>
                        <input type="number" id="ink_width_mm" value="0" step="1" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label for="ink_thickness_mm">Ink Thickness (mm)</label>
                        <input type="number" id="ink_thickness_mm" value="0" step="1" onchange="calculateAll()">
                    </div>
                    <div class="input-group">
                        <label for="contour_length_per_layer_mm">Contour Length per Layer (mm)</label>
                        <input type="number" class="editable" value="0" step="10" onchange="calculateAll()" id="contour_length_per_layer_mm">
                    </div>
                    <div class="input-group">
                        <label for="layer_amount">Total Layer Amount</label>
                        <input type="number" class="editable" value="0" step="1" onchange="calculateAll()" id="layer_amount">
                    </div>
                    <div class="input-group">
                        <label>Total Extrusion Length (m)</label>
                        <div class="calculated" id="total_extrusion_length_m">0 m</div>
                    </div>
                    <div class="input-group">
                        <label>Calculated Volume from Geometry (m¬≥)</label>
                        <div class="calculated" id="calculated_volume_m3">0 m¬≥</div>
                    </div>
                    <div class="input-group">
                        <label for="ink_extrusion_cost_per_meter">Cost per Meter Extrusion (IDR)</label>
                        <input type="number" class="editable" value="0" step="1" onchange="calculateAll()" id="ink_extrusion_cost_per_meter">
                    </div>
                    <div class="input-group">
                        <label>Total Ink Extrusion Cost</label>
                        <div class="calculated" id="ink_extrusion_total_cost">Rp 0</div>
                    </div>
                </div>
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>‚ÑπÔ∏è Note:</strong> The "Total Volume (m¬≥)" above is the main input for the overall project. Geometry parameters here are used for more detailed ink cost calculation and to provide an alternative volume estimate based on layer dimensions. **This Total Ink Extrusion Cost is for reference and NOT included in the project total.**
                </div>
            </div>
        </div>

        <!-- Material Batch Reference Section (Now dynamic) -->
        <div class="section" id="material-composition">
            <h3 class="section-header">
                <span>üìö Material Composition Reference Per Batch</span>
                <button class="toggle-button" onclick="toggleSection('material-composition-content', this)">-</button>
            </h3>
            <div id="material-composition-content" class="section-content">
                <div class="input-group" style="margin-bottom: 20px;">
                    <label for="mix_design_select">Select Mix Design:</label>
                    <select id="mix_design_select" onchange="selectMixDesign(this.value); calculateAll();"></select>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Qty (Kg/L)</th>
                                <th>Volume (m¬≥)</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody id="material_batch_reference_tbody">
                            <!-- Content will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üí° Note:</strong> This table shows the composition of the **selected** material batch. Material costs in the "Raw Materials" section are calculated based on the project volume input you provide.
                </div>
            </div>
        </div>

        <!-- Material Quantity Summary Section -->
        <div class="section" id="material-quantity">
            <h3 class="section-header">
                <span>‚öñÔ∏è Material Quantity Summary (Per Project)</span>
                <button class="toggle-button" onclick="toggleSection('material-quantity-content', this)">-</button>
            </h3>
            <div id="material-quantity-content" class="section-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Qty per m¬≥ (from input)</th>
                                <th>Total Quantity (Kg/Unit)</th>
                            </tr>
                        </thead>
                        <tbody id="material_qty_summary_tbody">
                            <!-- Content will be generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üí° Note:</strong> Total quantities are calculated based on your project volume. Use this to estimate logistics and procurement needs.
                </div>
            </div>
        </div>

        <!-- Printer Selection Section -->
        <div class="section" id="printer-selection">
            <h3 class="section-header">
                <span>üñ®Ô∏è 3D Printer Selection & Equipment Rental</span>
                <button class="toggle-button" onclick="toggleSection('printer-selection-content', this)">-</button>
            </h3>
            <div id="printer-selection-content" class="section-content">
                <div class="printer-selection">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">Select Printer Brand & Rental Option:</h4>
                    <div class="printer-cards" id="printer_cards">
                        <!-- Printer cards will be generated by JavaScript -->
                    </div>
                    <div class="alert alert-info" id="selected_printer_feedback" style="margin-top: 15px;">
                        Currently selected: None
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üí° Rental Information:</strong> Prices include operator training and basic maintenance. Purchase options include a 5-year warranty and full technical support.
                    </div>
                </div>
            </div>
        </div>

        <!-- Materials Section -->
        <div class="section" id="raw-materials">
            <h3 class="section-header">
                <span>üß± Raw Materials (Per Project Volume)</span>
                <button class="toggle-button" onclick="toggleSection('raw-materials-content', this)">-</button>
            </h3>
            <div id="raw-materials-content" class="section-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Description</th>
                                <th>Qty per m¬≥ (calculated)</th>
                                <th>Price per Unit</th>
                                <th>Use</th>
                                <th>Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="materials_tbody">
                            <tr>
                                <td>Ink Powder</td>
                                <td>Cost: $600/ton (~9600 IDR/Kg)</td>
                                <td><input type="number" class="editable" data-cost-type="material-qty" value="0" step="0.01" onchange="calculateAll()" id="ink_powder_qty_per_m3" readonly> Kg/m¬≥</td>
                                <td><input type="number" class="editable" data-cost-type="material-price" value="9600" onchange="calculateAll()" id="ink_powder_price_per_kg"> IDR/Kg</td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="ink_cost"></td>
                            </tr>
                            <tr>
                                <td>Portland Cement</td>
                                <td>Red Lion Brand</td>
                                <td><input type="number" class="editable" data-cost-type="material-qty" value="0" step="0.01" onchange="calculateAll()" id="cement_qty_per_m3" readonly> Kg/m¬≥</td>
                                <td><input type="number" class="editable" data-cost-type="material-price" value="1375" onchange="calculateAll()" id="cement_price_per_kg"> IDR/Kg</td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="cement_cost"></td>
                            </tr>
                            <tr>
                                <td>River Sand</td>
                                <td>From Karangasem</td>
                                <td><input type="number" class="editable" data-cost-type="material-qty" value="0" step="0.01" onchange="calculateAll()" id="sand_qty_per_m3" readonly> Kg/m¬≥</td>
                                <td><input type="number" class="editable" data-cost-type="material-price" value="175" onchange="calculateAll()" id="sand_price_per_kg"> IDR/Kg</td>
                                <td><input type="checkbox" class="use-checkbox" data-target-inputs=".material-sand-inputs" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="sand_cost"></td>
                            </tr>
                            <tr>
                                <td>Plastic/Tarpaulin</td>
                                <td>10% Unit/cost</td>
                                <td><input type="number" class="editable" data-cost-type="material-qty" value="0" step="0.1" onchange="calculateAll()" id="plastic_qty_per_unit" readonly> Unit/m¬≥</td>
                                <td><input type="number" class="editable" data-cost-type="material-price" value="9600" onchange="calculateAll()" id="plastic_price_per_unit"> IDR/Unit</td>
                                <td><input type="checkbox" class="use-checkbox" data-target-inputs=".material-plastic-inputs" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="plastic_cost"></td>
                            </tr>
                            <tr>
                                <td>Water</td>
                                <td>Clean Water</td>
                                <td><input type="number" class="editable" data-cost-type="material-qty" value="0" step="0.01" onchange="calculateAll()" id="water_qty_per_m3" readonly> L/m¬≥</td>
                                <td><input type="number" class="editable" data-cost-type="material-price" value="1400" onchange="calculateAll()" id="water_price_per_l"> IDR/L</td>
                                <td><input type="checkbox" class="use-checkbox" data-target-inputs=".material-water-inputs" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="water_cost"></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="5"><strong>Total Raw Materials per m¬≥</strong></td>
                                <td class="calculated" id="materials_total"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn add-item-button" onclick="addMaterialRow()">+ Add Material</button>
                </div>
            </div>
        </div>

        <div class="section" id="equipment">
            <h3 class="section-header">
                <span>üöö Additional Equipment & Rentals</span>
                <button class="toggle-button" onclick="toggleSection('equipment-content', this)">-</button>
            </h3>
            <div id="equipment-content" class="section-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Equipment Description</th>
                                <th>Duration (Unit)</th>
                                <th>Unit Type</th>
                                <th>Rate per Unit</th>
                                <th>Use</th>
                                <th>Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="equipment_tbody">
                            <tr class="subheader-row">
                                <td colspan="6" style="background-color: #F0F4FA; font-weight: bold; text-align: center;">Distribution</td>
                            </tr>
                            <tr>
                                <td>Mobile Crane</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="8" onchange="calculateAll()" id="crane_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="812500" onchange="calculateAll()" id="crane_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="crane_cost"></td>
                            </tr>
                            <tr>
                                <td>Truck Crane</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="8" onchange="calculateAll()" id="truck_crane_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="500000" onchange="calculateAll()" id="truck_crane_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="truck_crane_cost"></td>
                            </tr>
                            <tr>
                                <td>Truck</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="8" onchange="calculateAll()" id="truck_rental_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="375000" onchange="calculateAll()" id="truck_rental_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="truck_rental_cost"></td>
                            </tr>
                            <tr>
                                <td>Forklift</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="8" onchange="calculateAll()" id="forklift_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="275000" onchange="calculateAll()" id="forklift_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="forklift_cost"></td>
                            </tr>
                            <tr>
                                <td>Pickup</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="1" onchange="calculateAll()" id="pickup_rental_qty"></td>
                                <td>Trip</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="450000" onchange="calculateAll()" id="pickup_rental_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="pickup_rental_cost"></td>
                            </tr>
                            <tr class="subheader-row">
                                <td colspan="6" style="background-color: #F0F4FA; font-weight: bold; text-align: center;">Equipment</td>
                            </tr>
                            <tr>
                                <td>Concrete Mixer Rental (manual pour)</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="mixer_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="20833" onchange="calculateAll()" id="mixer_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="mixer_cost"></td>
                            </tr>
                            <tr>
                                <td>Compressor Rental for Tools</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="compressor_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="8333" onchange="calculateAll()" id="compressor_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="compressor_cost"></td>
                            </tr>
                            <tr>
                                <td>Angle Grinder</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="grinder_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="8333" onchange="calculateAll()" id="grinder_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="grinder_cost"></td>
                            </tr>
                            <tr>
                                <td>Brushless Drill</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="1" onchange="calculateAll()" id="drill_qty"></td>
                                <td>Unit</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="100000" onchange="calculateAll()" id="drill_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="drill_cost"></td>
                            </tr>
                            <tr class="subheader-row">
                                <td colspan="6" style="background-color: #F0F4FA; font-weight: bold; text-align: center;">Miscellaneous Rentals & Consumables</td>
                            </tr>
                            <tr>
                                <td>Fuel & Power Consumption</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="24" onchange="calculateAll()" id="fuel_qty"></td>
                                <td>Hours</td>
                                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="12500" onchange="calculateAll()" id="fuel_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="fuel_cost"></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="5"><strong>Equipment Subtotal</strong></td>
                                <td class="calculated" id="equipment_total"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn add-item-button" onclick="addEquipmentRow()">+ Add Equipment</button>
                </div>
            </div>
        </div>

        <div class="section" id="labor">
            <h3 class="section-header">
                <span>üë∑ Labor Costs</span>
                <button class="toggle-button" onclick="toggleSection('labor-content', this)">-</button>
            </h3>
            <div id="labor-content" class="section-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Time (Minutes/Day)</th>
                                <th>Rate per Hour</th>
                                <th>Use</th>
                                <th>Total Cost</th>
                            </tr>
                        </thead>
                        <tbody id="labor_tbody">
                            <tr>
                                <td>Field Worker</td>
                                <td>250K IDR / 8 Hours</td>
                                <td><input type="number" class="editable" data-cost-type="labor-qty" value="2" onchange="calculateAll()" id="workers_qty" data-default-qty="2"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="workers_time"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-rate" value="31250" onchange="calculateAll()" id="workers_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="workers_cost"></td>
                            </tr>
                            <tr>
                                <td>OP Leader</td>
                                <td>500K IDR / 8 Hours</td>
                                <td><input type="number" class="editable" data-cost-type="labor-qty" value="1" onchange="calculateAll()" id="leader_qty" data-default-qty="1"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="leader_time"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-rate" value="62500" onchange="calculateAll()" id="leader_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="leader_cost"></td>
                            </tr>
                            <tr>
                                <td>Mixing Crew</td>
                                <td>Per Batch Mixing</td>
                                <td><input type="number" class="editable" data-cost-type="labor-qty" value="2" onchange="calculateAll()" id="mixing_crew_qty"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="mixing_crew_time"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-rate" value="30000" onchange="calculateAll()" id="mixing_crew_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="mixing_crew_cost"></td>
                            </tr>
                            <tr>
                                <td>Printer Operator</td>
                                <td>Per Printer Operation</td>
                                <td><input type="number" class="editable" data-cost-type="labor-qty" value="1" onchange="calculateAll()" id="printer_operator_qty"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="printer_operator_time"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-rate" value="40000" onchange="calculateAll()" id="printer_operator_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="printer_operator_cost"></td>
                            </tr>
                            <tr>
                                <td>Daily Worker (Load/Unload)</td>
                                <td>200K IDR / 8 Hours</td>
                                <td><input type="number" class="editable" data-cost-type="labor-qty" value="0" onchange="calculateAll()" id="daily_workers_qty"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()" id="daily_workers_time"></td>
                                <td><input type="number" class="editable" data-cost-type="labor-rate" value="25000" onchange="calculateAll()" id="daily_workers_rate"></td>
                                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                                <td class="calculated" id="daily_workers_cost"></td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="6"><strong>Total Labor Cost</strong></td>
                                <td class="calculated" id="labor_total"></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn add-item-button" onclick="addLaborRow()">+ Add Labor Position</button>
                </div>
            </div>
        </div>

        <div class="cost-per-cubic">
            <h2>üí∞ Cost per Cubic Meter (m¬≥)</h2>
            <div class="amount" id="cost_per_cubic">Rp 0</div>
            <p>Total project volume: <span id="display_volume">0.00</span> m¬≥</p>
        </div>

        <div class="section summary-section" id="cost-summary">
            <h3 class="section-header">
                <span>üìä Project Cost Summary</span>
                <button class="toggle-button" onclick="toggleSection('cost-summary-content', this)">-</button>
            </h3>
            <div id="cost-summary-content" class="section-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Total Project</th> <!-- Removed Cost per m¬≥ -->
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="summary_tbody">
                            <tr>
                                <td>3D Printer</td>
                                <td id="selected_printer_summary">Not Selected</td>
                                <td class="calculated" id="printer_project_total">0</td>
                                <td class="calculated" id="printer_percentage">0%</td>
                            </tr>
                            <tr>
                                <td>Equipment & Rentals</td>
                                <td>Additional tools and equipment</td>
                                <td class="calculated" id="equipment_project_total">0</td>
                                <td class="calculated" id="equipment_percentage">0%</td>
                            </tr>
                            <tr>
                                <td>Raw Materials</td>
                                <td>Concrete mix components</td>
                                <td class="calculated" id="materials_project_total">0</td>
                                <td class="calculated" id="materials_percentage">0%</td>
                            </tr>
                            <tr>
                                <td>Labor</td>
                                <td>Workers and supervision</td>
                                <td class="calculated" id="labor_project_total">0</td>
                                <td class="calculated" id="labor_percentage">0%</td>
                            </tr>
                            <tr>
                                <td>Rebar</td>
                                <td>Steel bars and accessories for segments</td>
                                <td class="calculated" id="rebar_project_total">0</td>
                                <td class="calculated" id="rebar_percentage">0%</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="2"><strong>TOTAL PROJECT</strong></td> <!-- Adjusted colspan -->
                                <td class="calculated" id="grand_total_project">0</td>
                                <td class="calculated" id="grand_total_percentage">100%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <button onclick="window.print()" class="btn print-button">üñ®Ô∏è Print Report</button>
        <button onclick="exportToImage()" class="btn export-button">üñºÔ∏è Export to Image</button>

        <!-- New Section: Calculation History -->
        <div class="section" style="margin-top: 30px;" id="history">
            <h3 class="section-header">
                <span>üìú Calculation History</span>
                <button class="toggle-button" onclick="toggleSection('history-content', this)">-</button>
            </h3>
            <div id="history-content" class="section-content">
                <p>Your User ID: <span id="user_id_display">Loading...</span></p>
                <div class="table-container">
                    <table id="history_table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Project Name</th>
                                <th>Total Volume (m¬≥)</th>
                                <th>Cost per m¬≥</th>
                                <th>Total Project Cost</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="history_tbody">
                            <!-- History items will be loaded here by JavaScript -->
                            <tr><td colspan="6" style="text-align: center;">Loading history...</td></tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn" style="margin-top: 20px;" onclick="clearHistory()">Clear All History</button>
                <button type="button" class="btn" style="margin-top: 20px; margin-left: 10px;" onclick="saveCurrentCalculation()">üíæ Save Current Calculation</button>
            </div>
        </div>

        <!-- Hidden elements for scheduling data -->
        <div id="hidden_scheduling_data" style="display: none;">
            <span id="total_mixing_hours_needed_display" data-hours="0"></span>
            <span id="total_printing_hours_needed_display" data-hours="0"></span>
        </div>

        <!-- New Section: Support Us / Donation -->
        <div class="section donation-section" style="margin-top: 30px;" id="support">
            <h3 class="section-header">
                <span>üíñ Support Our Work</span>
                <button class="toggle-button" onclick="toggleSection('support-content', this)">-</button>
            </h3>
            <div id="support-content" class="section-content">
                <p style="margin-bottom: 20px;">If this calculator has been useful to you, please consider making a small donation to support its development and maintenance. Every contribution helps!</p>
                
                <!-- PayPal Donate Button Code - Replace with YOUR PayPal generated code -->
                <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
                    <input type="hidden" name="cmd" value="_donations" />
                    <input type="hidden" name="business" value="nicolchristan@gmail.com" /> <!-- Diperbarui dengan alamat email PayPal Anda -->
                    <input type="hidden" name="item_name" value="Support 3D Concrete Calculator" />
                    <input type="hidden" name="currency_code" value="USD" />
                    <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
                    <img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
                </form>
                <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                    Thank You
                </p>
                <!-- End PayPal Donate Button Code -->
            </div>
        </div>

    </div>

    <script>
        // Global flag to indicate if currently printing or exporting image
        let isExportingOrPrinting = false;

        // Function to update the hidden span for printing Project Name
        function updateProjectNameForPrint() {
            const projectNameInput = document.getElementById('project_name');
            const printProjectNameSpan = document.getElementById('print_project_name');
            if (projectNameInput) printProjectNameSpan.textContent = projectNameInput.value;
        }

        // Data for available printers and their rental/purchase options
        const PRINTERS = [
            {
                name: "Win Sun",
                options: [
                    { label: "Hourly Rental", rate: 148625, unit: "hour" },
                    { label: "8-Hour Rental (per day)", rate: 3567000 / 3, unit: "8-hour" },
                    { label: "Daily Rental (24h)", rate: 3567000, unit: "day" },
                    { label: "Monthly Rental", rate: 108520000, unit: "month" },
                    { label: "Annual Rental", rate: 1302240000, unit: "year" },
                    { label: "Purchase (5 Years)", rate: 6511200000, unit: "one-time" }
                ]
            },
            {
                name: "GearBuild",
                options: [
                    { label: "Hourly Rental", rate: 64057, unit: "hour" },
                    { label: "8-Hour Rental (per day)", rate: 1537367 / 3, unit: "8-hour" },
                    { label: "Daily Rental (24h)", rate: 1537367, unit: "day" }, 
                    { label: "Monthly Rental", rate: 46121000, unit: "month" },
                    { label: "Annual Rental", rate: 553425000, unit: "year" },
                    { label: "Purchase (5 Years)", rate: 2767260000, unit: "one-time" }
                ]
            },
            {
                name: "SJ",
                options: [
                    { label: "Hourly Rental", rate: 29732, unit: "hour" },
                    { label: "8-Hour Rental (per day)", rate: 713556 / 3, unit: "8-hour" },
                    { label: "Daily Rental (24h)", rate: 713556, unit: "day" },
                    { label: "Monthly Rental", rate: 21704000, unit: "month" },
                    { label: "Annual Rental", rate: 260448000, unit: "year" },
                    { label: "Purchase (5 Years)", rate: 1302240000, unit: "one-time" }
                ]
            }
        ];

        let selectedPrinter = null;
        let selectedPrinterOption = null;

        // Define different mix designs
        const MIX_DESIGNS = [
            {
                name: "Standard Mix",
                composition: {
                    ink_powder: { kg: 20, volume_m3_in_batch: 0.0216, cost_idr: 20 * 9600 },
                    portland_cement: { kg: 20, volume_m3_in_batch: 0.0162, cost_idr: 20 * 1375 },
                    river_sand: { kg: 60, volume_m3_in_batch: 0.0162, cost_idr: 60 * 175 },
                    plastic_tarpaulin: { unit: 2, volume_m3_in_batch: 0, cost_idr: 19200 },
                    water: { liter: 14, volume_m3_in_batch: 0.027, cost_idr: 14 * 1400 },
                    total_volume_per_batch_m3: 0.081, // Updated based on user's research
                    mixing_time_per_batch_hours: 0.25 // Updated based on user's research (1 hour for 0.081 m¬≥)
                },
                description: "Standard composition for general 3D concrete printing based on new research."
            },
            {
                name: "High Strength Mix",
                composition: {
                    ink_powder: { kg: 25, volume_m3_in_batch: 0.045, cost_idr: 240000 },
                    portland_cement: { kg: 30, volume_m3_in_batch: 0.04, cost_idr: 41250 },
                    river_sand: { kg: 45, volume_m3_in_batch: 0.025, cost_idr: 7875 }, // 45 Kg * 175 Rp/Kg
                    plastic_tarpaulin: { unit: 2, volume_m3_in_batch: 0, cost_idr: 19200 },
                    water: { liter: 12, volume_m3_in_batch: 0.045, cost_idr: 16800 },
                    total_volume_per_batch_m3: 0.155, // Slightly different volume
                    mixing_time_per_batch_hours: 0.75 // Longer mixing time for high strength
                },
                description: "High strength mix for structural applications."
            },
            {
                name: "Lightweight Mix",
                composition: {
                    ink_powder: { kg: 15, volume_m3_in_batch: 0.035, cost_idr: 144000 },
                    portland_cement: { kg: 15, volume_m3_in_batch: 0.025, cost_idr: 20625 },
                    river_sand: { kg: 30, volume_m3_in_batch: 0.015, cost_idr: 5250 }, // 30 Kg * 175 Rp/Kg
                    lightweight_aggregate: { kg: 40, volume_m3_in_batch: 0.06, cost_idr: 50000 }, // New material example
                    plastic_tarpaulin: { unit: 2, volume_m3_in_batch: 0, cost_idr: 19200 },
                    water: { liter: 15, volume_m3_in_batch: 0.055, cost_idr: 21000 },
                    total_volume_per_batch_m3: 0.19, // Larger volume for lightweight mix
                    mixing_time_per_batch_hours: 0.6 // Slightly longer mixing
                },
                description: "Lightweight mix for non-structural applications."
            }
        ];

        let selectedMixDesign = MIX_DESIGNS[0]; // Default to Standard Mix


        // New: Define exchange rates relative to IDR (1 unit of currency = X IDR)
        const EXCHANGE_RATES_TO_IDR = {
            'IDR': 1,      // 1 IDR = 1 IDR
            'USD': 16300,  // 1 USD = ~16,300 IDR (approx. June 2025)
            'CNY': 2250,   // 1 CNY = ~2,250 IDR
            'EUR': 17500,  // 1 EUR = ~17,500 IDR
            'JPY': 105,    // 1 JPY = ~105 IDR
            'GBP': 20500,  // 1 GBP = ~20,500 IDR
            'AUD': 10800,  // 1 AUD = ~10,800 IDR
            'CAD': 11800,  // 1 CAD = ~11,800 IDR
            'CHF': 18300   // 1 CHF = ~18,300 IDR
        };

        // New: Define currency symbols and formatting locales
        const CURRENCY_FORMATS = {
            'IDR': { symbol: 'Rp', locale: 'id-ID' },
            'USD': { symbol: '$', locale: 'en-US' },
            'CNY': { symbol: '¬•', locale: 'zh-CN' },
            'EUR': { symbol: '‚Ç¨', locale: 'de-DE' },
            'JPY': { symbol: '¬•', locale: 'ja-JP' },
            'GBP': { symbol: '¬£', locale: 'en-GB' },
            'AUD': { symbol: 'A$', locale: 'en-AU' },
            'CAD': { symbol: 'C$', locale: 'en-CA' },
            'CHF': { symbol: 'CHF', locale: 'de-CH' }
        };

        let selectedCurrencyCode = 'IDR'; // Default selected currency

        // New: Function to update the selected currency
        function updateCurrency() {
            const selector = document.getElementById('currency_selector');
            if (selector) {
                selectedCurrencyCode = selector.value;
                calculateAll(); // Recalculate to update all displayed costs
            }
        }

        // Function to format numbers to selected currency with USD indicator
        function formatCost(amountInIDR) {
            // If we are printing or exporting image, omit the USD part for cleaner layout
            if (isExportingOrPrinting) {
                const currentCurrencyValue = amountInIDR / EXCHANGE_RATES_TO_IDR[selectedCurrencyCode];
                const formatter = new Intl.NumberFormat(CURRENCY_FORMATS[selectedCurrencyCode].locale, {
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
                return `${CURRENCY_FORMATS[selectedCurrencyCode].symbol} ${formatter.format(currentCurrencyValue)}`;
            }
            
            // Calculate and format the USD equivalent
            const usdAmount = amountInIDR / EXCHANGE_RATES_TO_IDR['USD'];
            const formattedUsd = usdAmount.toFixed(2); // Two decimal places for USD

            // Calculate and format the selected currency amount
            const currentCurrencyValue = amountInIDR / EXCHANGE_RATES_TO_IDR[selectedCurrencyCode];
            const formatter = new Intl.NumberFormat(CURRENCY_FORMATS[selectedCurrencyCode].locale, {
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            });
            const formattedCurrentCurrency = formatter.format(currentCurrencyValue);

            // Combine both with inline styling for USD in browser view
            return `${CURRENCY_FORMATS[selectedCurrencyCode].symbol} ${formattedCurrentCurrency} <span class="usd-currency">(${formattedUsd} USD)</span>`;
        }

        // Function to format quantities (e.g., Kg, L, Unit)
        function formatQuantity(amount, unit) {
            if (typeof amount !== 'number' || isNaN(amount)) {
                return `N/A ${unit}`;
            }
            return `${amount.toFixed(2)} ${unit}`;
        }

        // Function to render printer cards dynamically
        function renderPrinterCards() {
            const printerCardsContainer = document.getElementById('printer_cards');
            if (!printerCardsContainer) return; // Add null check
            printerCardsContainer.innerHTML = '';

            PRINTERS.forEach((printer, printerIndex) => {
                const printerCard = document.createElement('div');
                printerCard.className = 'printer-card';
                const pricingOptionsHtml = printer.options.map((option, optionIndex) => `
                    <div class="pricing-option" 
                        data-printer-index="${printerIndex}" 
                        data-option-index="${optionIndex}" 
                        onclick="selectPrinter('${printer.name}', ${printerIndex}, ${optionIndex})">
                        <div class="price-amount">${formatCost(option.rate)}</div>
                        <div class="price-label">${option.label}</div>
                    </div>
                `).join('');

                printerCard.innerHTML = `
                    <div class="printer-name">${printer.name}</div>
                    <div class="pricing-options">
                        ${pricingOptionsHtml}
                    </div>
                `;
                printerCardsContainer.appendChild(printerCard);
            });
        }

        // Function to select a printer and its pricing option
        function selectPrinter(printerName, printerIndex, optionIndex) {
            const allPrinterOptions = document.querySelectorAll('.pricing-option');
            allPrinterOptions.forEach(option => option.classList.remove('selected'));

            const selectedOptionElement = document.querySelector(`.pricing-option[data-printer-index="${printerIndex}"][data-option-index="${optionIndex}"]`);
            if (selectedOptionElement) selectedOptionElement.classList.add('selected');

            const allPrinterCards = document.querySelectorAll('.printer-card');
            allPrinterCards.forEach(card => card.classList.remove('selected'));
            if (selectedOptionElement) { // Check if selectedOptionElement exists before accessing its properties
                const closestPrinterCard = selectedOptionElement.closest('.printer-card');
                if (closestPrinterCard) closestPrinterCard.classList.add('selected');
            }


            selectedPrinter = PRINTERS[printerIndex];
            selectedPrinterOption = selectedPrinter.options[optionIndex];
            
            calculateAll(); // Recalculate everything including rebar cost
            const selectedPrinterFeedback = document.getElementById('selected_printer_feedback');
            if (selectedPrinterFeedback) selectedPrinterFeedback.textContent = `Currently selected: ${selectedPrinter.name} - ${selectedPrinterOption.label}`;
        }

        // Function to render mix design options
        function renderMixDesignOptions() {
            const mixDesignSelect = document.getElementById('mix_design_select');
            if (!mixDesignSelect) return; // Add null check
            mixDesignSelect.innerHTML = ''; // Clear existing options

            MIX_DESIGNS.forEach((mix, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = mix.name;
                mixDesignSelect.appendChild(option);
            });
            // Select the default mix design
            mixDesignSelect.value = 0;
            selectMixDesign(0); // Trigger initial selection and rendering
        }

        // Function to select a mix design and update the reference table
        function selectMixDesign(index) {
            selectedMixDesign = MIX_DESIGNS[parseInt(index)];
            const refTbody = document.getElementById('material_batch_reference_tbody');
            if (!refTbody) return; // Add null check
            refTbody.innerHTML = ''; // Clear previous content

            let totalBatchCost = 0;
            const composition = selectedMixDesign.composition;

            // Helper to add rows to the reference table
            const addRefRow = (name, qty, volume, cost) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${qty}</td>
                    <td>${volume === 'N/A' ? 'N/A' : volume.toFixed(4)}</td>
                    <td>${formatCost(cost)}</td> <!-- Use formatCost here for proper display -->
                `;
                refTbody.appendChild(row);
            };

            for (const materialKey in composition) {
                if (materialKey === 'total_volume_per_batch_m3' || materialKey === 'mixing_time_per_batch_hours') continue;

                const material = composition[materialKey];
                let qtyDisplay = '';
                let volumeDisplay = material.volume_m3_in_batch;
                let costDisplay = material.cost_idr;

                if (material.kg) qtyDisplay = `${material.kg} Kg`;
                else if (material.liter) qtyDisplay = `${material.liter} L`;
                else if (material.unit) qtyDisplay = `${material.unit} Unit`;

                // Translate material keys for display in the batch reference table
                let translatedMaterialName;
                switch (materialKey) {
                    case 'ink_powder': translatedMaterialName = 'Ink Powder'; break;
                    case 'portland_cement': translatedMaterialName = 'Portland Cement'; break;
                    case 'river_sand': translatedMaterialName = 'River Sand'; break;
                    case 'plastic_tarpaulin': translatedMaterialName = 'Plastic/Tarpaulin'; break;
                    case 'water': translatedMaterialName = 'Water'; break;
                    case 'lightweight_aggregate': translatedMaterialName = 'Lightweight Aggregate'; break;
                    default: translatedMaterialName = materialKey.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()); break;
                }

                addRefRow(translatedMaterialName, qtyDisplay, volumeDisplay, costDisplay);
                totalBatchCost += material.cost_idr;
            }

            // Add total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td><strong>Total per Batch</strong></td>
                <td></td>
                <td>~${selectedMixDesign.composition.total_volume_per_batch_m3.toFixed(4)}</td>
                <td>${formatCost(totalBatchCost)}</td> <!-- Use formatCost here for proper display -->
            `;
            refTbody.appendChild(totalRow);

            calculateAll(); // Recalculate all costs after mix design selection
        }


        // Function to calculate the 3D printer cost
        function calculatePrinterCost() {
            let total_volume = parseFloat(document.getElementById('total_volume').value) || 0;
            let printer_operating_hours_per_day = parseFloat(document.getElementById('printer_operating_hours_per_day').value) || 0;
            
            let printerCost = 0; // This will be in IDR
            let printerDescription = "Not Selected";

            // Define a printing rate (m¬≥ per hour) - UPDATED TO 0.3 m¬≥/hour
            const printing_rate_m3_per_hour = 0.3;  
            let total_printing_hours_needed = 0;

            if (total_volume > 0 && printing_rate_m3_per_hour > 0) {
                total_printing_hours_needed = total_volume / printing_rate_m3_per_hour;
            }

            if (selectedPrinter && selectedPrinterOption) {
                const rate = selectedPrinterOption.rate; // Rate is in IDR
                const unit = selectedPrinterOption.unit;
                printerDescription = `${selectedPrinter.name} - ${selectedPrinterOption.label}`;

                if (unit === "hour") { // Hourly Rental (per hour)
                    printerCost = rate * total_printing_hours_needed;
                } else if (unit === "8-hour") { // 8-Hour Rental (per day)
                    // Calculate days needed based on 8-hour shifts
                    const printing_days_needed_8hr_shift = total_printing_hours_needed / 8;
                    printerCost = rate * printing_days_needed_8hr_shift;
                } else if (unit === "day") { // Daily Rental (24h)
                    const printing_days_needed_24hr_shift = total_printing_hours_needed / 24;
                    printerCost = rate * printing_days_needed_24hr_shift;
                } else if (unit === "month") { // Monthly Rental
                    const printing_months_needed = total_printing_hours_needed / (30 * 24); // Assuming 30 days, 24 hours/day for monthly calculation basis
                    printerCost = rate * printing_months_needed;
                } else if (unit === "year") { // Yearly Rental
                    const printing_years_needed = total_printing_hours_needed / (365 * 24); // Assuming 365 days, 24 hours/day for yearly calculation basis
                    printerCost = rate * printing_years_needed;
                } else if (unit === "one-time") {
                    printerCost = rate; // Fixed purchase cost
                }
            }

            const selectedPrinterSummary = document.getElementById('selected_printer_summary');
            if (selectedPrinterSummary) selectedPrinterSummary.textContent = printerDescription;
            return { cost: printerCost, total_printing_hours_needed: total_printing_hours_needed };
        }

        // Function to calculate additional equipment and rentals cost
        function calculateEquipment() {
            let totalCost = 0; // This will be in IDR
            const equipmentRows = document.querySelectorAll('#equipment_tbody tr:not(.total-row):not(.subheader-row)'); 

            equipmentRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const calculatedCell = row.querySelector('.calculated');

                if (!checkbox || checkbox.checked) {
                    const qtyInput = row.querySelector('input[data-cost-type="equipment-qty"]');
                    const rateInput = row.querySelector('input[data-cost-type="equipment-rate"]');
                    
                    let quantity = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    let rate = parseFloat(rateInput ? rateInput.value : 0) || 0; // Rate is in IDR
                    
                    const rowTotal = quantity * rate;
                    
                    if (calculatedCell) {
                        calculatedCell.innerHTML = formatCost(rowTotal); // Changed to innerHTML
                    }
                    totalCost += rowTotal;
                } else {
                    if (calculatedCell) {
                        calculatedCell.innerHTML = formatCost(0); // Changed to innerHTML
                    }
                }
            });
            const equipmentTotal = document.getElementById('equipment_total');
            if (equipmentTotal) equipmentTotal.innerHTML = formatCost(totalCost); // Changed to innerHTML
            return totalCost;
        }

        // Function to update the independent ink extrusion cost display
        function updateInkExtrusionCostDisplay() {
            const ink_width_mm = parseFloat(document.getElementById('ink_width_mm').value) || 0;
            const ink_thickness_mm = parseFloat(document.getElementById('ink_thickness_mm').value) || 0;
            const contour_length_per_layer_mm = parseFloat(document.getElementById('contour_length_per_layer_mm').value) || 0;
            const layer_amount = parseFloat(document.getElementById('layer_amount').value) || 0;

            const total_extrusion_length_m = (contour_length_per_layer_mm * layer_amount) / 1000;
            const totalExtrusionLengthM = document.getElementById('total_extrusion_length_m');
            if (totalExtrusionLengthM) totalExtrusionLengthM.textContent = `${total_extrusion_length_m.toFixed(2)} m`;

            const volume_per_meter_extrusion_m3 = (ink_width_mm / 1000) * (ink_thickness_mm / 1000) * 1;
            const calculated_volume_m3 = volume_per_meter_extrusion_m3 * total_extrusion_length_m;
            const calculatedVolumeM3 = document.getElementById('calculated_volume_m3');
            if (calculatedVolumeM3) calculatedVolumeM3.textContent = `${calculated_volume_m3.toFixed(4)} m¬≥`;
            // Updated: Changed `$m^3$` to `m¬≥`


            const inkExtrusionPricePerMeter = parseFloat(document.getElementById('ink_extrusion_cost_per_meter').value) || 0; // This is in IDR
            const inkExtrusionTotalCost = inkExtrusionPricePerMeter * total_extrusion_length_m;
            const inkExtrusionTotalCostElement = document.getElementById('ink_extrusion_total_cost');
            if (inkExtrusionTotalCostElement) inkExtrusionTotalCostElement.innerHTML = formatCost(inkExtrusionTotalCost); // Changed to innerHTML
        }

        // Function to calculate raw materials cost (excluding independent ink extrusion)
        function calculateMaterials() {
            let totalCost = 0; // This will be in IDR
            let total_volume = parseFloat(document.getElementById('total_volume').value) || 0;
            let waste_percentage = parseFloat(document.getElementById('waste_percentage').value) || 0;

            // Adjust total volume by waste percentage
            total_volume *= (1 + (waste_percentage / 100));
            
            const composition = selectedMixDesign.composition;
            const total_volume_per_batch_m3 = composition.total_volume_per_batch_m3;


            // Update Qty per m¬≥ inputs based on selected mix design composition
            const materialRows = document.querySelectorAll('#materials_tbody tr:not(.total-row)');
            const materialQtySummaryTbody = document.getElementById('material_qty_summary_tbody');
            if (!materialQtySummaryTbody) return 0; // Add null check
            materialQtySummaryTbody.innerHTML = '';

            materialRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const calculatedCostCell = row.querySelector('.calculated');
                const materialNameElement = row.querySelector('td:nth-child(1)');
                const materialName = materialNameElement ? materialNameElement.textContent.trim() : '';
                const qtyInput = row.querySelector('input[data-cost-type="material-qty"]');
                const priceInput = row.querySelector('input[data-cost-type="material-price"]'); // Price is in IDR
                
                let unitText = '';
                if (qtyInput) {
                    // Extract unit from the original HTML text sibling of the quantity input
                    // Diperbarui: Mencari teks yang mengandung /m¬≥ atau unit spesifik
                    const unitNode = Array.from(row.childNodes).find(node => node.nodeType === Node.TEXT_NODE && (node.textContent.includes('/m¬≥') || node.textContent.includes('Unit') || node.textContent.includes('L')));
                    if (unitNode) {
                        unitText = unitNode.textContent.trim().split('/')[0].trim();
                    } else if (materialName === 'Plastic/Tarpaulin') {
                        unitText = 'Unit';
                    } else if (materialName === 'Water') {
                        unitText = 'L';
                    } else {
                        unitText = 'Kg'; // Default for other materials
                    }
                }
                

                // Determine material key for mix composition lookup (e.g., "Ink Powder" -> "ink_powder")
                let materialKey = materialName.toLowerCase().replace(/ /g, '_');
                // Special handling for 'Portland Cement' (originally 'Portland Cement')
                if (materialName === 'Ink Powder') materialKey = 'ink_powder';
                else if (materialName === 'Portland Cement') materialKey = 'portland_cement';
                else if (materialName === 'River Sand') materialKey = 'river_sand';
                else if (materialName === 'Plastic/Tarpaulin') materialKey = 'plastic_tarpaulin';
                else if (materialName === 'Water') materialKey = 'water';

                const materialInMix = composition[materialKey];
                const isMaterialInMix = materialInMix !== undefined;

                if (isMaterialInMix) {
                    // Update the readonly quantity input with the value from the selected mix design
                    let quantityValue;
                    if (materialInMix.kg !== undefined) {
                        quantityValue = (materialInMix.kg / total_volume_per_batch_m3);
                    } else if (materialInMix.liter !== undefined) {
                        quantityValue = (materialInMix.liter / total_volume_per_batch_m3);
                    } else if (materialInMix.unit !== undefined) {
                        quantityValue = (materialInMix.unit / total_volume_per_batch_m3);
                    } else {
                        quantityValue = 0; // Fallback
                    }
                    if (qtyInput) qtyInput.value = quantityValue.toFixed(2);
                    
                    // Re-enable inputs and remove disabled-row class if it's part of the mix
                    row.classList.remove('disabled-row');
                    if (qtyInput) qtyInput.removeAttribute('disabled');
                    if (priceInput) priceInput.removeAttribute('disabled');
                    if (checkbox) checkbox.removeAttribute('disabled'); // Ensure checkbox is enabled
                } else {
                    // If material is not in the current mix design, disable inputs and set qty to 0
                    if (qtyInput) qtyInput.value = 0;
                    row.classList.add('disabled-row');
                    if (qtyInput) qtyInput.setAttribute('disabled', 'true');
                    if (priceInput) priceInput.setAttribute('disabled', 'true');
                    if (checkbox) {
                        checkbox.checked = false; // Uncheck it automatically if not in mix
                        checkbox.setAttribute('disabled', 'true'); // Disable checkbox
                    }
                }

                // Now calculate cost based on checkbox state and whether it's enabled (from mix or manual enable)
                if ((!checkbox || checkbox.checked) && !row.classList.contains('disabled-row')) { 
                    const quantityPerM3 = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    const price = parseFloat(priceInput ? priceInput.value : 0) || 0; // Price is in IDR
                    
                    const rowCostTotal = quantityPerM3 * price * total_volume; 
                    
                    if (calculatedCostCell) {
                        calculatedCostCell.innerHTML = formatCost(rowCostTotal);
                    }
                    totalCost += rowCostTotal;

                    // Update Material Quantity Summary
                    const totalQuantity = quantityPerM3 * total_volume;
                    const newQtySummaryRow = document.createElement('tr');
                    newQtySummaryRow.innerHTML = `
                        <td>${materialName}</td>
                        <td>${formatQuantity(quantityPerM3, unitText)}</td>
                        <td>${formatQuantity(totalQuantity, unitText)}</td>
                    `;
                    materialQtySummaryTbody.appendChild(newQtySummaryRow);
                } else {
                    // If unchecked or disabled by mix, set cost to 0 and add to summary as 0 quantity
                    if (calculatedCostCell) {
                        calculatedCostCell.innerHTML = formatCost(0);
                    }
                    const newQtySummaryRow = document.createElement('tr');
                    newQtySummaryRow.classList.add('disabled-row'); // Indicate it's disabled or not used
                    newQtySummaryRow.innerHTML = `
                        <td>${materialName}</td>
                        <td>${formatQuantity(0, unitText)}</td>
                        <td>${formatQuantity(0, unitText)}</td>
                    `;
                    materialQtySummaryTbody.appendChild(newQtySummaryRow);
                }
            });

            const materialsTotalQty = calculateMaterialTotalQuantity();
            const totalQtySummaryRow = document.createElement('tr');
            totalQtySummaryRow.classList.add('total-row');
            totalQtySummaryRow.innerHTML = `
                <td colspan="2"><strong>Total Material Quantity</strong></td>
                <td class="calculated" id="all_materials_total_qty">${formatQuantity(materialsTotalQty, 'Kg')}</td>
            `;
            materialQtySummaryTbody.appendChild(totalQtySummaryRow);


            const materialsTotalElement = document.getElementById('materials_total');
            if (materialsTotalElement) materialsTotalElement.innerHTML = formatCost(totalCost);
            return totalCost;
        }

        // New function to calculate total quantity of materials (sum of all Kgs/Units)
        function calculateMaterialTotalQuantity() {
            let totalCombinedQuantity = 0;
            const total_volume = parseFloat(document.getElementById('total_volume').value) || 0;
            let waste_percentage = parseFloat(document.getElementById('waste_percentage').value) || 0;

            const adjusted_total_volume = total_volume * (1 + (waste_percentage / 100));

            const materialRows = document.querySelectorAll('#materials_tbody tr:not(.total-row)');
            materialRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const materialNameElement = row.querySelector('td:nth-child(1)');
                const materialName = materialNameElement ? materialNameElement.textContent.trim() : '';
                
                // Determine material key for mix composition lookup
                let materialKey = materialName.toLowerCase().replace(/ /g, '_');
                if (materialName === 'Ink Powder') materialKey = 'ink_powder';
                else if (materialName === 'Portland Cement') materialKey = 'portland_cement';
                else if (materialName === 'River Sand') materialKey = 'river_sand';
                else if (materialName === 'Plastic/Tarpaulin') materialKey = 'plastic_tarpaulin';
                else if (materialName === 'Water') materialKey = 'water';

                const isMaterialInMix = selectedMixDesign.composition[materialKey] !== undefined;

                if ((!checkbox || checkbox.checked) && isMaterialInMix) {
                    const qtyInput = row.querySelector('input[data-cost-type="material-qty"]');
                    const quantityPerM3 = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    
                    // Only include in the total quantity if it's NOT Plastic/Tarpaulin (assuming this is not measured in Kg for total)
                    // and its part of the selected mix
                    if (materialKey !== 'plastic_tarpaulin') { // Use materialKey to check against internal names
                        totalCombinedQuantity += (quantityPerM3 * adjusted_total_volume);
                    }
                }
            });
            return totalCombinedQuantity;
        }


        // Function to calculate labor cost
        function calculateLabor() {
            let totalCost = 0; // This will be in IDR
            const laborRows = document.querySelectorAll('#labor_tbody tr:not(.total-row)');
            let project_duration_days = parseFloat(document.getElementById('project_duration').value) || 0;
            const totalMixingHoursNeededDisplay = document.getElementById('total_mixing_hours_needed_display');
            let total_mixing_hours_needed = parseFloat(totalMixingHoursNeededDisplay ? totalMixingHoursNeededDisplay.dataset.hours : 0) || 0; // Get from data attribute
            const totalPrintingHoursNeededDisplay = document.getElementById('total_printing_hours_needed_display');
            let total_printing_hours_needed = parseFloat(totalPrintingHoursNeededDisplay ? totalPrintingHoursNeededDisplay.dataset.hours : 0) || 0; // Get from data attribute


            laborRows.forEach(row => {
                const checkbox = row.querySelector('.use-checkbox');
                const calculatedCell = row.querySelector('.calculated');

                if (!checkbox || checkbox.checked) {
                    const positionElement = row.querySelector('td:first-child');
                    const position = positionElement ? positionElement.textContent.trim() : '';
                    const qtyInput = row.querySelector('input[data-cost-type="labor-qty"]');
                    const timeInput = row.querySelector('input[data-cost-type="labor-time"]'); // Minutes per day
                    const rateInput = row.querySelector('input[data-cost-type="labor-rate"]'); // Rate per hour (in IDR)

                    let quantity = parseFloat(qtyInput ? qtyInput.value : 0) || 0;
                    let timePerDayMinutes = parseFloat(timeInput ? timeInput.value : 0) || 0;
                    let ratePerHour = parseFloat(rateInput ? rateInput.value : 0) || 0; // Rate is in IDR
                    
                    let projectTotalCost = 0;

                    // Specific labor calculations based on roles and calculated project hours
                    if (position === "Mixing Crew") {
                        // Calculate total hours for mixing crew based on total mixing hours needed
                        projectTotalCost = quantity * ratePerHour * total_mixing_hours_needed;
                    } else if (position === "Printer Operator") {
                        // Calculate total hours for printer operator based on total printing hours needed
                        projectTotalCost = quantity * ratePerHour * total_printing_hours_needed;
                    } else {
                        // For other roles like Field Workers, Leader, Daily Workers, scale by overall project duration
                        const hoursPerDay = timePerDayMinutes / 60;
                        projectTotalCost = quantity * hoursPerDay * ratePerHour * project_duration_days;
                    }

                    if (calculatedCell) {
                        calculatedCell.innerHTML = formatCost(projectTotalCost);
                    }
                    totalCost += projectTotalCost;
                } else {
                    if (calculatedCell) {
                        calculatedCell.innerHTML = formatCost(0);
                    }
                }
            });
            const laborTotal = document.getElementById('labor_total');
            if (laborTotal) laborTotal.innerHTML = formatCost(totalCost);
            return totalCost;
        }

        // Rebar Calculation Logic (Integrated from rebar_calculation.html)
        // Data rebar weight per meter
        const rebarWeights = {
            8: 0.395,
            10: 0.617,
            12: 0.888,
            13: 1.042,
            16: 1.578
        };

        function calculateRebarSection() {
            const length = parseFloat(document.getElementById('rebar_length_mm').value) || 0;
            const width = parseFloat(document.getElementById('rebar_width_mm').value) || 0;
            const height = parseFloat(document.getElementById('rebar_height_mm').value) || 0;
            const segments = parseInt(document.getElementById('rebar_segments').value) || 1;
            const rebarPrice = parseFloat(document.getElementById('rebar_price_per_kg').value) || 18000; // Price in IDR
            
            // Validate inputs
            if (length <= 0 || width <= 0 || height <= 0 || segments <= 0) {
                console.warn("Please enter valid dimensions and number of segments for rebar calculation.");
                // Set all rebar displays to 0
                const rebarTotalWeightDisplay = document.getElementById('rebar_total_weight_display');
                if (rebarTotalWeightDisplay) rebarTotalWeightDisplay.textContent = `0 kg`;
                
                const rebarTotalLengthDisplay = document.getElementById('rebar_total_length_display');
                if (rebarTotalLengthDisplay) rebarTotalLengthDisplay.textContent = `0 m`;
                
                const rebarTotalCostDisplay = document.getElementById('rebar_total_cost_display');
                if (rebarTotalCostDisplay) rebarTotalCostDisplay.innerHTML = formatCost(0);
                
                const rebarTotalBarsDisplay = document.getElementById('rebar_total_bars_display');
                if (rebarTotalBarsDisplay) rebarTotalBarsDisplay.textContent = `0 bars`;
                
                const rebarDetailTableBody = document.getElementById('rebarDetailTableBody');
                if (rebarDetailTableBody) rebarDetailTableBody.innerHTML = '';
                
                const rebarPriceGrid = document.getElementById('rebarPriceGrid');
                if (rebarPriceGrid) rebarPriceGrid.innerHTML = '';
                
                const rebarNotesList = document.getElementById('rebarNotesList');
                if (rebarNotesList) {
                    rebarNotesList.innerHTML = `
                        <li>Calculation based on <strong>0 segments</strong>.</li>
                        <li>Rebar price: <strong>${formatCost(rebarPrice)}/kg</strong></li>
                        <li>Estimate with 10% tolerance: <strong>0 kg</strong> / <strong>${formatCost(0)}</strong></li>
                    `;
                }
                return 0; // Return 0 cost if inputs are invalid
            }
            
            // Convert mm to m
            const L = length / 1000;
            const W = width / 1000;
            const H = height / 1000;
            
            // Calculate joint lengths
            const longitudinalJoints = (segments - 1) * L; // Longitudinal joints
            const transverseJoints = segments * 2 * W; // Transverse joints (2 sides per segment)
            const perimeter = 2 * (segments * L + W); // Ring beam perimeter
            
            // Calculate rebar requirements
            const calculations = [
                {
                    type: 'Longitudinal Joints',
                    length: longitudinalJoints,
                    diameter: 12,
                    rows: 2,
                    totalLength: longitudinalJoints * 2,
                    weight: longitudinalJoints * 2 * rebarWeights[12]
                },
                {
                    type: 'Transverse Joints',
                    length: transverseJoints,
                    diameter: 10,
                    rows: 2,
                    totalLength: transverseJoints * 2,
                    weight: transverseJoints * 2 * rebarWeights[10]
                },
                {
                    type: 'Perimeter Ring Beam',
                    length: perimeter,
                    diameter: 13,
                    rows: 4,
                    totalLength: perimeter * 4,
                    weight: perimeter * 4 * rebarWeights[13]
                },
                {
                    type: 'Stirrups for Joints',
                    length: 0, // This is not a direct length, but quantity based
                    diameter: 8,
                    rows: 0,
                    totalLength: Math.max(0, segments * 10), // Example: 10 meters per segment, minimum 60m
                    weight: Math.max(0, segments * 10) * rebarWeights[8]
                },
                {
                    type: 'Dowel/Connectors',
                    length: 0, // This is not a direct length, but quantity based
                    diameter: 10,
                    rows: 0,
                    totalLength: Math.max(0, segments * 8), // Example: 8 meters per segment, minimum 48m
                    weight: Math.max(0, segments * 8) * rebarWeights[10]
                }
            ];
            
            // Calculate totals
            let totalWeight = 0;
            let totalLength = 0;
            let totalCost = 0; // This will be in IDR
            
            calculations.forEach(calc => {
                totalWeight += calc.weight;
                totalLength += calc.totalLength;
                totalCost += calc.weight * rebarPrice;
            });
            
            const totalBars = Math.ceil(totalLength / 12); // Assuming 12m standard rebar length

            displayRebarResults(calculations, totalWeight, totalLength, totalCost, totalBars, rebarPrice, segments);
            return totalCost; // Return the total rebar cost (in IDR) for the main calculation
        }
        
        function displayRebarResults(calculations, totalWeight, totalLength, totalCost, totalBars, rebarPrice, segments) {
            // Summary cards
            const rebarTotalWeightDisplay = document.getElementById('rebar_total_weight_display');
            if (rebarTotalWeightDisplay) rebarTotalWeightDisplay.textContent = `${Math.round(totalWeight)} kg`;
            
            const rebarTotalLengthDisplay = document.getElementById('rebar_total_length_display');
            if (rebarTotalLengthDisplay) rebarTotalLengthDisplay.textContent = `${Math.round(totalLength)} m`;
            
            const rebarTotalCostDisplay = document.getElementById('rebar_total_cost_display');
            if (rebarTotalCostDisplay) rebarTotalCostDisplay.innerHTML = formatCost(totalCost);
            
            const rebarTotalBarsDisplay = document.getElementById('rebar_total_bars_display');
            if (rebarTotalBarsDisplay) rebarTotalBarsDisplay.textContent = `${totalBars} bars`;
            
            // Detail table
            const rebarDetailTableBody = document.getElementById('rebarDetailTableBody');
            if (rebarDetailTableBody) rebarDetailTableBody.innerHTML = '';
            
            if (rebarDetailTableBody) {
                calculations.forEach(calc => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${calc.type}</strong></td>
                        <td>${calc.length.toFixed(2)}</td>
                        <td>D${calc.diameter}</td>
                        <td>${calc.rows || '-'}</td>
                        <td>${calc.totalLength.toFixed(1)}</td>
                        <td>${calc.weight.toFixed(1)}</td>
                    `;
                    rebarDetailTableBody.appendChild(row);
                });
            }
            
            // Price breakdown by diameter
            const rebarPriceGrid = document.getElementById('rebarPriceGrid'); 
            if (rebarPriceGrid) rebarPriceGrid.innerHTML = '';
            
            if (rebarPriceGrid) {
                const diameters = [...new Set(calculations.map(c => c.diameter))];
                
                diameters.forEach(diameter => {
                    const relevantCalcs = calculations.filter(c => c.diameter === diameter);
                    const diameterLength = relevantCalcs.reduce((sum, calc) => sum + calc.totalLength, 0);
                    const diameterWeight = relevantCalcs.reduce((sum, calc) => sum + calc.weight, 0);
                    const diameterCost = diameterWeight * rebarPrice; // Cost is in IDR
                    const diameterBars = Math.ceil(diameterLength / 12);
                    
                    const priceItem = document.createElement('div');
                    priceItem.className = 'price-item';
                    priceItem.innerHTML = `
                        <strong>D${diameter}</strong><br>
                        ${diameterLength.toFixed(1)}m<br>
                        ${diameterWeight.toFixed(1)}kg<br>
                        ${diameterBars} bars<br>
                        <strong>${formatCost(diameterCost)}</strong>
                    `;
                    rebarPriceGrid.appendChild(priceItem); 
                });
            }
            
            // Notes
            const rebarNotesList = document.getElementById('rebarNotesList');
            if (rebarNotesList) {
                rebarNotesList.innerHTML = `
                    <li>Calculation is based on the **specific segment dimensions and number of segments** you input in this section, for on-site assembly.</li>
                    <li>This calculation **does NOT automatically scale with the overall "Total Volume (m¬≥)"** of your project. If you manually adjust the project's "Total Volume" and need the rebar cost to reflect that scale, you must manually adjust the "Number of Segments" or other dimensions in this section.</li>
                    <li>Rebar is primarily for **segment joints** and tie structures.</li>
                    <li>Add **10% tolerance** for field adjustments.</li>
                    <li>Prepare **grooves/channels** on segments for rebar placement.</li>
                    <li>Ensure proper alignment before final grouting.</li>
                `;
            }
        }

        // Function to toggle row and input states based on checkbox
        function toggleRow(checkbox) {
            const row = checkbox.closest('tr');
            const inputs = row.querySelectorAll('input.editable'); 
            
            if (checkbox.checked) {
                row.classList.remove('disabled-row');
                inputs.forEach(input => {
                    // Only restore original value if it's a number input, not readonly, and currently 0
                    if (input.type === 'number' && input.dataset.originalValue && parseFloat(input.value) === 0 && !input.readOnly) {
                        input.value = input.dataset.originalValue;
                        delete input.dataset.originalValue;
                    }
                    input.removeAttribute('disabled');
                });
            } else {
                row.classList.add('disabled-row');
                inputs.forEach(input => {
                    // Store current value if it's a number input and not readonly
                    if (input.type === 'number' && input.value !== "0" && !input.readOnly) {
                        input.dataset.originalValue = input.value;
                    }
                    input.setAttribute('disabled', 'true');
                    // Clear value only if it's a number input and not readonly
                    if (input.type === 'number' && !input.readOnly) {
                        input.value = 0;
                    }
                });
            }
            calculateAll();
        }

        // Functions for adding new rows dynamically
        function addMaterialRow() {
            const tbody = document.getElementById('materials_tbody');
            if (!tbody) return; // Add null check
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="editable" value="New Material" data-cost-type="material-name" onchange="calculateAll()"></td>
                <td><input type="text" class="editable" value="Custom Description" data-cost-type="material-desc" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="material-qty" value="1" step="0.1" onchange="calculateAll()"> Kg/m¬≥</td>
                <td><input type="number" class="editable" data-cost-type="material-price" value="1000" onchange="calculateAll()"> IDR/Kg</td>
                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                <td class="calculated"></td>
            `;
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                tbody.insertBefore(newRow, totalRow);
            } else {
                tbody.appendChild(newRow);
            }
            updateTotalColspan('materials_tbody');
            calculateAll();
        }

        function addEquipmentRow() {
            const tbody = document.getElementById('equipment_tbody');
            if (!tbody) return; // Add null check
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="editable" value="New Equipment" data-cost-type="equipment-name" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="equipment-qty" value="1" onchange="calculateAll()"></td>
                <td>Unit</td>
                <td><input type="number" class="editable" data-cost-type="equipment-rate" value="100000" onchange="calculateAll()"></td>
                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                <td class="calculated"></td>
            `;
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                tbody.insertBefore(newRow, totalRow);
            } else {
                tbody.appendChild(newRow);
            }
            updateTotalColspan('equipment_tbody');
            calculateAll();
        }

        function addLaborRow() {
            const tbody = document.getElementById('labor_tbody');
            if (!tbody) return; // Add null check
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="editable" value="New Worker" data-cost-type="labor-name" onchange="calculateAll()"></td>
                <td>Custom Task</td>
                <td><input type="number" class="editable" data-cost-type="labor-qty" value="1" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="labor-time" value="480" onchange="calculateAll()"></td>
                <td><input type="number" class="editable" data-cost-type="labor-rate" value="20000" onchange="calculateAll()"></td>
                <td><input type="checkbox" class="use-checkbox" checked onchange="toggleRow(this)"></td>
                <td class="calculated"></td>
            `;
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                tbody.insertBefore(newRow, totalRow);
            } else {
                tbody.appendChild(newRow);
            }
            updateTotalColspan('labor_tbody');
            calculateAll();
        }

        // Function to dynamically update colspan for total rows
        function updateTotalColspan(tbodyId) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return; // Add null check
            const totalRow = tbody.querySelector('.total-row');
            if (totalRow) {
                const totalTextCell = totalRow.querySelector('td:first-child');
                const exampleRow = tbody.querySelector('tr:not(.total-row):not(.subheader-row)');
                if (exampleRow) {
                    const numDataCellsInRow = exampleRow.querySelectorAll('td').length;
                    if (totalTextCell) totalTextCell.setAttribute('colspan', numDataCellsInRow - 1);
                } else {
                    const numHeaders = tbody.closest('table').querySelectorAll('thead th').length;
                    if (totalTextCell) totalTextCell.setAttribute('colspan', numHeaders - 1);
                }
            }
        }

        // Function to update the visibility and readonly state of L, W, H inputs
        function updateVolumeSource() {
            const calcFromLWHCheckbox = document.getElementById('calc_volume_from_lwh');
            const lengthInput = document.getElementById('length_mm');
            const widthInput = document.getElementById('width_mm');
            const heightInput = document.getElementById('height_mm');
            const totalVolumeInput = document.getElementById('total_volume');

            if (!calcFromLWHCheckbox || !lengthInput || !widthInput || !heightInput || !totalVolumeInput) return; // Add null checks

            if (calcFromLWHCheckbox.checked) {
                lengthInput.removeAttribute('disabled');
                widthInput.removeAttribute('disabled');
                heightInput.removeAttribute('disabled');
                totalVolumeInput.setAttribute('readonly', 'true');
                // Force recalculate total_volume from LWH when checkbox is checked
                const length = parseFloat(lengthInput.value) || 0;
                const width = parseFloat(widthInput.value) || 0;
                const height = parseFloat(heightInput.value) || 0;
                const volume = (length / 1000) * (width / 1000) * (height / 1000);
                totalVolumeInput.value = volume.toFixed(4);
            } else {
                lengthInput.setAttribute('disabled', 'true');
                widthInput.setAttribute('disabled', 'true');
                heightInput.setAttribute('disabled', 'true');
                totalVolumeInput.removeAttribute('readonly');
            }
            calculateAll(); // Recalculate after source changes
        }


        // Main function to calculate all costs and update the summary
        function calculateAll() {
            let total_volume;
            const calcFromLWHCheckbox = document.getElementById('calc_volume_from_lwh');
            const totalVolumeElement = document.getElementById('total_volume');
            const displayVolumeElement = document.getElementById('display_volume');

            if (!calcFromLWHCheckbox || !totalVolumeElement || !displayVolumeElement) return; // Add null checks for critical elements


            if (calcFromLWHCheckbox.checked) {
                const length_mm = parseFloat(document.getElementById('length_mm').value) || 0;
                const width_mm = parseFloat(document.getElementById('width_mm').value) || 0;
                const height_mm = parseFloat(document.getElementById('height_mm').value) || 0;
                total_volume = (length_mm / 1000) * (width_mm / 1000) * (height_mm / 1000);
                totalVolumeElement.value = total_volume.toFixed(4); // Update readonly field
            } else {
                total_volume = parseFloat(totalVolumeElement.value) || 0;
            }
            
            displayVolumeElement.textContent = total_volume.toFixed(2);


            // --- Automate Project Duration and Scheduling ---
            const printerOperatingHoursPerDay = document.getElementById('printer_operating_hours_per_day');
            const mixingOperatingHoursPerDay = document.getElementById('mixing_operating_hours_per_day');
            const projectDurationElement = document.getElementById('project_duration');
            const projectDurationHoursMinutes = document.getElementById('project_duration_hours_minutes');


            const printer_operating_hours_per_day = parseFloat(printerOperatingHoursPerDay ? printerOperatingHoursPerDay.value : 0) || 0;
            const mixing_operating_hours_per_day = parseFloat(mixingOperatingHoursPerDay ? mixingOperatingHoursPerDay.value : 0) || 0;
            
            // Printing Time Calculation (re-use logic from calculatePrinterCost for hours needed)
            const printing_rate_m3_per_hour = 0.3; // UPDATED PRINTING RATE TO 0.3
            let total_printing_hours_needed = 0;
            if (total_volume > 0 && printing_rate_m3_per_hour > 0) {
                total_printing_hours_needed = total_volume / printing_rate_m3_per_hour;
            }
            // Store for labor calculation
            // These elements are now static in the HTML, so no need to check for existence here.
            const totalPrintingHoursDisplay = document.getElementById('total_printing_hours_needed_display');
            if (totalPrintingHoursDisplay) {
                totalPrintingHoursDisplay.dataset.hours = total_printing_hours_needed;
            }


            // Mixing Time Calculation (using selected mix design's mixing time per batch)
            const volume_per_batch_for_mixing = selectedMixDesign.composition.total_volume_per_batch_m3;
            const mixing_time_per_batch_hours = selectedMixDesign.composition.mixing_time_per_batch_hours; // e.g., 0.5 hours

            let total_mixing_hours_needed = 0;
            if (total_volume > 0 && volume_per_batch_for_mixing > 0) {
                const num_batches = total_volume / volume_per_batch_for_mixing;
                total_mixing_hours_needed = num_batches * mixing_time_per_batch_hours;
            }
            // Store for labor calculation
            // These elements are now static in the HTML, so no need to check for existence here.
            const totalMixingHoursDisplay = document.getElementById('total_mixing_hours_needed_display');
            if (totalMixingHoursDisplay) {
                totalMixingHoursDisplay.dataset.hours = total_mixing_hours_needed;
            }


            // Calculate project duration based on the critical path (max of printing or mixing time)
            let calculated_project_duration_days = 0;
            if (printer_operating_hours_per_day > 0 && mixing_operating_hours_per_day > 0) {
                const printing_days = total_printing_hours_needed / printer_operating_hours_per_day;
                const mixing_days = total_mixing_hours_needed / mixing_operating_hours_per_day;
                calculated_project_duration_days = Math.max(printing_days, mixing_days);
            } else if (printer_operating_hours_per_day > 0) {
                calculated_project_duration_days = total_printing_hours_needed / printer_operating_hours_per_day;
            } else if (mixing_operating_hours_per_day > 0) {
                calculated_project_duration_days = total_mixing_hours_needed / mixing_operating_hours_per_day;
            } else {
                 calculated_project_duration_days = total_printing_hours_needed / 8; // Fallback to 8 hours/day
            }

            if (projectDurationElement) projectDurationElement.value = calculated_project_duration_days.toFixed(2);

            const display_hours = Math.floor(calculated_project_duration_days * (printer_operating_hours_per_day > 0 ? printer_operating_hours_per_day : 8));
            const display_minutes = Math.round((calculated_project_duration_days * (printer_operating_hours_per_day > 0 ? printer_operating_hours_per_day : 8) * 60) % 60);
            if (projectDurationHoursMinutes) projectDurationHoursMinutes.textContent = `(${display_hours} hours, ${display_minutes} minutes)`;
            // --- End Automate Project Duration and Scheduling ---


            updateInkExtrusionCostDisplay();


            const printer_result = calculatePrinterCost(); // This now returns an object { cost, total_printing_hours_needed }
            const printer_cost = printer_result.cost; // In IDR

            const equipment_total = calculateEquipment(); // In IDR
            const materials_total = calculateMaterials(); // In IDR
            const labor_total = calculateLabor(); // In IDR
            const rebar_total = calculateRebarSection(); // In IDR


            const grand_total_project = printer_cost + equipment_total + materials_total + labor_total + rebar_total;
            
            let cost_per_cubic = 0;
            if (total_volume > 0) {
                cost_per_cubic = grand_total_project / total_volume;
            }

            const costPerCubicElement = document.getElementById('cost_per_cubic');
            if (costPerCubicElement) costPerCubicElement.innerHTML = formatCost(cost_per_cubic);

            // Removed Cost per m¬≥ from summary table update
            // const printerPerCubic = document.getElementById('printer_per_cubic');
            // if (printerPerCubic) printerPerCubic.innerHTML = formatCost(printer_cost / (total_volume > 0 ? total_volume : 1));
            const printerProjectTotal = document.getElementById('printer_project_total');
            if (printerProjectTotal) printerProjectTotal.innerHTML = formatCost(printer_cost);

            // const equipmentPerCubic = document.getElementById('equipment_per_cubic');
            // if (equipmentPerCubic) equipmentPerCubic.innerHTML = formatCost(equipment_total / (total_volume > 0 ? total_volume : 1));
            const equipmentProjectTotal = document.getElementById('equipment_project_total');
            if (equipmentProjectTotal) equipmentProjectTotal.innerHTML = formatCost(equipment_total);

            // const materialsPerCubic = document.getElementById('materials_per_cubic');
            // if (materialsPerCubic) materialsPerCubic.innerHTML = formatCost(materials_total / (total_volume > 0 ? total_volume : 1));
            const materialsProjectTotal = document.getElementById('materials_project_total');
            if (materialsProjectTotal) materialsProjectTotal.innerHTML = formatCost(materials_total);

            // const laborPerCubic = document.getElementById('labor_per_cubic');
            // if (laborPerCubic) laborPerCubic.innerHTML = formatCost(labor_total / (total_volume > 0 ? total_volume : 1));
            const laborProjectTotal = document.getElementById('labor_project_total');
            if (laborProjectTotal) laborProjectTotal.innerHTML = formatCost(labor_total);

            // const rebarPerCubic = document.getElementById('rebar_per_cubic');
            // if (rebarPerCubic) rebarPerCubic.innerHTML = formatCost(rebar_total / (total_volume > 0 ? total_volume : 1));
            const rebarProjectTotal = document.getElementById('rebar_project_total');
            if (rebarProjectTotal) rebarProjectTotal.innerHTML = formatCost(rebar_total);

            // const grandTotalPerCubic = document.getElementById('grand_total_per_cubic');
            // if (grandTotalPerCubic) grandTotalPerCubic.innerHTML = formatCost(cost_per_cubic);
            const grandTotalProjectElement = document.getElementById('grand_total_project');
            if (grandTotalProjectElement) grandTotalProjectElement.innerHTML = formatCost(grand_total_project);

            updatePercentages(grand_total_project, printer_cost, equipment_total, materials_total, labor_total, rebar_total);
            // saveHistory(grand_total_project, cost_per_cubic); // Removed automatic save
        }

        // New function to explicitly save current calculation to history
        function saveCurrentCalculation() {
            let total_volume = parseFloat(document.getElementById('total_volume').value) || 0;
            
            // Recalculate all costs to ensure latest values are saved
            const printer_result = calculatePrinterCost();
            const printer_cost = printer_result.cost;
            const equipment_total = calculateEquipment();
            const materials_total = calculateMaterials();
            const labor_total = calculateLabor();
            const rebar_total = calculateRebarSection();

            const grand_total_project = printer_cost + equipment_total + materials_total + labor_total + rebar_total;
            let cost_per_cubic = 0;
            if (total_volume > 0) {
                cost_per_cubic = grand_total_project / total_volume;
            }

            // Prepare the breakdownDetails object with raw numeric values
            const breakdownDetails = {
                printer: {
                    description: document.getElementById('selected_printer_summary')?.textContent || 'N/A',
                    costPerCubic: printer_cost / (total_volume > 0 ? total_volume : 1), // Pass raw numeric
                    totalProject: printer_cost // Pass raw numeric
                },
                equipment: {
                    costPerCubic: equipment_total / (total_volume > 0 ? total_volume : 1), // Pass raw numeric
                    totalProject: equipment_total // Pass raw numeric
                },
                materials: {
                    costPerCubic: materials_total / (total_volume > 0 ? total_volume : 1), // Pass raw numeric
                    totalProject: materials_total // Pass raw numeric
                },
                labor: {
                    costPerCubic: labor_total / (total_volume > 0 ? total_volume : 1), // Pass raw numeric
                    totalProject: labor_total // Pass raw numeric
                },
                rebar: {
                    costPerCubic: rebar_total / (total_volume > 0 ? total_volume : 1), // Pass raw numeric
                    totalProject: rebar_total // Pass raw numeric
                }
            };

            // Call saveHistory with the raw numeric values and the breakdownDetails
            saveHistory(grand_total_project, cost_per_cubic, breakdownDetails);

            // Provide visual feedback
            const messageBox = document.createElement('div');
            messageBox.classList.add('alert', 'alert-info');
            messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; z-index: 1000;';
            messageBox.innerHTML = '<strong>Success:</strong> Current calculation saved to history!';
            document.body.appendChild(messageBox);
            setTimeout(() => messageBox.remove(), 3000);
        }

        // Function to update percentages in the summary table
        function updatePercentages(grandTotal, printerCost, equipmentCost, materialsCost, laborCost, rebarCost) {
            if (grandTotal === 0) {
                const printerPercentage = document.getElementById('printer_percentage');
                if (printerPercentage) printerPercentage.textContent = '0%';
                const equipmentPercentage = document.getElementById('equipment_percentage');
                if (equipmentPercentage) equipmentPercentage.textContent = '0%';
                const materialsPercentage = document.getElementById('materials_percentage');
                if (materialsPercentage) materialsPercentage.textContent = '0%';
                const laborPercentage = document.getElementById('labor_percentage');
                if (laborPercentage) laborPercentage.textContent = '0%';
                const rebarPercentage = document.getElementById('rebar_percentage');
                if (rebarPercentage) rebarPercentage.textContent = '0%';
                const grandTotalPercentage = document.getElementById('grand_total_percentage');
                if (grandTotalPercentage) grandTotalPercentage.textContent = '0%'; 
                return;
            }

            const printerPercentage = document.getElementById('printer_percentage');
            if (printerPercentage) printerPercentage.textContent = ((printerCost / grandTotal) * 100).toFixed(1) + '%';
            const equipmentPercentage = document.getElementById('equipment_percentage');
            if (equipmentPercentage) equipmentPercentage.textContent = ((equipmentCost / grandTotal) * 100).toFixed(1) + '%';
            const materialsPercentage = document.getElementById('materials_percentage');
            if (materialsPercentage) materialsPercentage.textContent = ((materialsCost / grandTotal) * 100).toFixed(1) + '%';
            const laborPercentage = document.getElementById('labor_percentage');
            if (laborPercentage) laborPercentage.textContent = ((laborCost / grandTotal) * 100).toFixed(1) + '%';
            const rebarPercentage = document.getElementById('rebar_percentage');
            if (rebarPercentage) rebarPercentage.textContent = ((rebarCost / grandTotal) * 100).toFixed(1) + '%';
            const grandTotalPercentage = document.getElementById('grand_total_percentage');
            if (grandTotalPercentage) grandTotalPercentage.textContent = '100%'; 
        }

        // Function to handle image preview
        function previewProjectImage(event) {
            const reader = new FileReader();
            reader.onload = function(){
                const output = document.getElementById('project_preview_image');
                if (output) {
                    output.src = reader.result;
                    output.style.display = 'block'; // Show the image
                }
            };
            if (event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
        }

        // Function to export the entire document content to an image
        async function exportToImage() {
            const body = document.body;
            const container = document.querySelector('.container');
            if (!body || !container) return; // Add null checks

            // Set flag to true before capturing
            isExportingOrPrinting = true;
            // Recalculate all to ensure Rupiah formatting is correct for export
            calculateAll();

            // Temporarily add a class to body to apply print-like styles for capture
            body.classList.add('export-mode');

            try {
                // Capture the content of the container
                const canvas = await html2canvas(container, {
                    scale: 2, // Increase scale for better resolution
                    useCORS: true // Needed if you have images from external domains
                });

                // Create a download link for the image
                const link = document.createElement('a');
                link.download = '3d_printed_concrete_cost_report.png';
                link.href = canvas.toDataURL('image/png'); // You can change to 'image/jpeg' if preferred
                document.body.appendChild(link); // Append to body to make it clickable
                link.click(); // Programmatically click the link to trigger download
                document.body.removeChild(link); // Clean up the link
            } catch (error) {
                console.error("Failed to export to image:", error);
                // Using alert() as a fallback for user notification, consider a custom modal
                const messageBox = document.createElement('div');
                messageBox.classList.add('alert', 'alert-info');
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; z-index: 1000;';
                messageBox.innerHTML = '<strong>Error:</strong> Failed to export report to image. Please try again.';
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 5000); // Remove after 5 seconds
            } finally {
                // Remove the class after capture, whether successful or not
                body.classList.remove('export-mode');
                // Reset flag and recalculate to show USD again
                isExportingOrPrinting = false;
                calculateAll();
            }
        }

        // Override window.print to set and unset the flag
        const originalPrint = window.print;
        window.print = function() {
            isExportingOrPrinting = true;
            calculateAll(); // Recalculate all to ensure Rupiah formatting is correct for print
            originalPrint();
            // Use a timeout to ensure print dialog is closed before reverting
            setTimeout(() => {
                isExportingOrPrinting = false;
                calculateAll(); // Reset to show USD again
            }, 1000); // A small delay to ensure rendering is complete
        };

        // --- Firestore History Functions ---
        async function saveHistory(grandTotalProject, costPerCubic, breakdownDetails) { // Added breakdownDetails parameter
            // Updated: Menggunakan window.isAuthReady() dan window.getUserId()
            if (!window.isAuthReady()) {
                console.log("Authentication not ready. Cannot save history.");
                return;
            }
            // Pastikan __app_id sudah tersedia dari lingkungan Canvas
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback if not defined in Canvas environment

            const historyCollection = window.collection(window.db, `artifacts/${appId}/users/${window.getUserId()}/calculations`); // Updated Firestore modular API
            const projectName = document.getElementById('project_name')?.value || 'Untitled Project'; // Add null check
            const totalVolume = parseFloat(document.getElementById('total_volume')?.value) || 0; // Add null check

            const historyData = {
                timestamp: window.serverTimestamp(),
                projectName: projectName,
                totalVolume: totalVolume,
                grandTotalProject: grandTotalProject, // Still save in IDR internally
                costPerCubic: costPerCubic,            // Still save in IDR internally
                selectedCurrency: selectedCurrencyCode, // Save the currency that was active when saved
                summaryDetails: breakdownDetails // Directly use the passed breakdownDetails
            };

            try {
                await window.addDoc(historyCollection, historyData); // Updated Firestore modular API
                console.log("Calculation saved to history.");
            } catch (error) {
                console.error("Error saving history:", error);
            }
        }

        function loadHistory() {
            const historyTbody = document.getElementById('history_tbody');
            if (!historyTbody) return;

            historyTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Loading history...</td></tr>';
            const userIdDisplay = document.getElementById('user_id_display');
            if (userIdDisplay) userIdDisplay.textContent = window.getUserId();

            // Wait for authentication to be ready before fetching data
            if (!window.isAuthReady()) {
                window.addEventListener('authReady', () => {
                    fetchAndDisplayHistory();
                }, { once: true }); // Listen only once
            } else {
                fetchAndDisplayHistory();
            }

            function fetchAndDisplayHistory() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback if not defined in Canvas environment
                // Updated Firestore modular API
                const historyCollectionRef = window.collection(window.db, `artifacts/${appId}/users/${window.getUserId()}/calculations`);
                const q = window.query(historyCollectionRef, window.orderBy('timestamp', 'desc'));

                window.onSnapshot(q, (snapshot) => {
                    historyTbody.innerHTML = ''; // Clear existing
                    if (snapshot.empty) {
                        historyTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No history found. Start calculating!</td></tr>';
                        return;
                    }

                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const date = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
                        // Always display history values in IDR for consistency, as they are saved in IDR
                        const displayCostPerCubic = data.costPerCubic ? formatCost(data.costPerCubic) : formatCost(0);
                        const displayGrandTotal = data.grandTotalProject ? formatCost(data.grandTotalProject) : formatCost(0);

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${date}</td>
                            <td>${data.projectName || 'N/A'}</td>
                            <td>${data.totalVolume ? data.totalVolume.toFixed(2) : '0.00'} m¬≥</td>
                            <td>${displayCostPerCubic}</td>
                            <td>${displayGrandTotal}</td>
                            <td><button onclick="viewHistoryDetails('${doc.id}')" class="btn" style="padding: 5px 10px; font-size: 0.8em;">View Details</button></td>
                        `;
                        historyTbody.appendChild(row);
                    });
                }, (error) => {
                    console.error("Error loading history:", error);
                    historyTbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: red;">Error loading history: ${error.message}</td></tr>`;
                });
            }
        }

        async function viewHistoryDetails(docId) {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback if not defined in Canvas environment
            // Updated Firestore modular API
            const docRef = window.doc(window.db, `artifacts/${appId}/users/${window.getUserId()}/calculations`, docId);
            try {
                const docSnap = await window.getDoc(docRef); 
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // When viewing details, display costs in the currency that was active when saved if possible,
                    // otherwise default to IDR, but always show USD equivalent for consistency with formatCost.
                    // For simplicity here, we will just format all original IDR values using the current selectedCurrencyCode.
                    // If a specific saved currency needs to be honored, more complex logic is needed.
                    let detailsHtml = `
                        <h3>Calculation Details: ${data.projectName}</h3>
                        <p>Date: ${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A'}</p>
                        <p>Total Volume: ${data.totalVolume ? data.totalVolume.toFixed(2) : '0.00'} m¬≥</p>
                        <p>Cost per m¬≥: ${data.costPerCubic ? formatCost(data.costPerCubic) : formatCost(0)}</p>
                        <p>Total Project Cost: ${data.grandTotalProject ? formatCost(data.grandTotalProject) : formatCost(0)}</p>
                        <h4>Cost Breakdown:</h4>
                        <ul>
                            <li>3D Printer: ${data.summaryDetails?.printer?.description || 'N/A'} - ${data.summaryDetails?.printer?.totalProject ? formatCost(data.summaryDetails.printer.totalProject) : formatCost(0)}</li>
                            <li>Equipment & Rentals: ${data.summaryDetails?.equipment?.totalProject ? formatCost(data.summaryDetails.equipment.totalProject) : formatCost(0)}</li>
                            <li>Raw Materials: ${data.summaryDetails?.materials?.totalProject ? formatCost(data.summaryDetails.materials.totalProject) : formatCost(0)}</li>
                            <li>Labor: ${data.summaryDetails?.labor?.totalProject ? formatCost(data.summaryDetails.labor.totalProject) : formatCost(0)}</li>
                            <li>Rebar: ${data.summaryDetails?.rebar?.totalProject ? formatCost(data.summaryDetails.rebar.totalProject) : formatCost(0)}</li>
                        </ul>
                    `;
                    // Display in a custom modal instead of alert
                    const modal = document.createElement('div');
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
                    modal.innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="margin: 0; color: #333;">Calculation Details</h3>
                                <button onclick="this.closest('.modal-backdrop').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #777;">&times;</button>
                            </div>
                            <div style="max-height: 70vh; overflow-y: auto; color: #555;">${detailsHtml}</div>
                        </div>
                    `;
                    modal.classList.add('modal-backdrop'); // Add a class for easy removal
                    document.body.appendChild(modal);

                } else {
                    const messageBox = document.createElement('div');
                    messageBox.classList.add('alert', 'alert-info');
                    messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; z-index: 1000;';
                    messageBox.innerHTML = '<strong>Error:</strong> No such document!';
                    document.body.appendChild(messageBox);
                    setTimeout(() => messageBox.remove(), 3000);
                }
            } catch (error) {
                console.error("Error viewing history details:", error);
                const messageBox = document.createElement('div');
                messageBox.classList.add('alert', 'alert-info');
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; z-index: 1000;';
                messageBox.innerHTML = '<strong>Error:</strong> Error viewing details: ' + error.message;
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 5000);
            }
        }

        async function clearHistory() {
            // Using custom modal instead of confirm()
            const confirmClear = await new Promise(resolve => {
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;';
                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                        <h3 style="margin-bottom: 20px; color: #333;">Clear History</h3>
                        <p style="margin-bottom: 30px; color: #555;">Are you sure you want to delete all your calculation history? This action cannot be undone.</p>
                        <button class="btn" style="background: #e63946; margin-right: 10px;" onclick="this.closest('.modal-backdrop').remove(); resolve(true);">Yes, Clear All</button>
                        <button class="btn" style="background: #ccc;" onclick="this.closest('.modal-backdrop').remove(); resolve(false);">Cancel</button>
                    </div>
                `;
                modal.classList.add('modal-backdrop');
                document.body.appendChild(modal);
            });

            if (!confirmClear) {
                return;
            }

            if (!window.isAuthReady()) {
                console.log("Authentication not ready. Cannot clear history.");
                const messageBox = document.createElement('div');
                messageBox.classList.add('alert', 'alert-info');
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; z-index: 1000;';
                messageBox.innerHTML = '<strong>Error:</strong> Authentication not ready. Please wait or refresh.';
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 3000);
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Fallback if not defined in Canvas environment
            
            // Updated Firestore modular API
            const historyCollectionRef = window.collection(window.db, `artifacts/${appId}/users/${window.getUserId()}/calculations`);
            const q = window.query(historyCollectionRef); // Query to get all documents for the user

            try {
                const snapshot = await window.getDocs(q); 
                const deletePromises = [];
                snapshot.forEach((doc) => {
                    deletePromises.push(window.deleteDoc(doc.ref)); 
                });
                await Promise.all(deletePromises);
                const messageBox = document.createElement('div');
                messageBox.classList.add('alert', 'alert-info');
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; z-index: 1000;';
                messageBox.innerHTML = '<strong>Success:</strong> All history cleared successfully!';
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 3000);
                // No need to manually clear tbody, onSnapshot will handle it.
            } catch (error) {
                console.error("Error clearing history:", error);
                const messageBox = document.createElement('div');
                messageBox.classList.add('alert', 'alert-info');
                messageBox.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; z-index: 1000;';
                messageBox.innerHTML = '<strong>Error:</strong> Error clearing history: ' + error.message;
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 5000);
            }
        }

        // Function to toggle the visibility of a section's content
        function toggleSection(contentId, button) {
            const content = document.getElementById(contentId);
            if (content) {
                if (content.style.display === 'none' || content.style.display === '') {
                    content.style.display = 'block';
                    button.textContent = '-'; // Changed to minus sign
                    button.classList.remove('collapsed');
                } else {
                    content.style.display = 'none';
                    button.textContent = '+'; // Changed to plus sign
                    button.classList.add('collapsed');
                }
            }
        }

        // Initialize calculations and load history on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial labor quantities as per user's preference FIRST
            // These elements must exist in the HTML before trying to set their values.
            // Ensure these IDs are present in the HTML for the labor table.
            const workersQtyInput = document.getElementById('workers_qty');
            if (workersQtyInput) workersQtyInput.value = "2"; // Reverted to original value

            const leaderQtyInput = document.getElementById('leader_qty');
            if (leaderQtyInput) leaderQtyInput.value = "1"; // Reverted to original value

            const dailyWorkersQtyInput = document.getElementById('daily_workers_qty');
            if (dailyWorkersQtyInput) dailyWorkersQtyInput.value = "0";

            const mixingCrewQtyInput = document.getElementById('mixing_crew_qty');
            if (mixingCrewQtyInput) mixingCrewQtyInput.value = "2"; // Reverted to original value

            const printerOperatorQtyInput = document.getElementById('printer_operator_qty');
            if (printerOperatorQtyInput) printerOperatorQtyInput.value = "1"; // Reverted to original value

            const workersTimeInput = document.getElementById('workers_time');
            if (workersTimeInput) workersTimeInput.value = "480"; // Reverted to original value

            const leaderTimeInput = document.getElementById('leader_time');
            if (leaderTimeInput) leaderTimeInput.value = "480"; // Reverted to original value

            const dailyWorkersTimeInput = document.getElementById('daily_workers_time');
            if (dailyWorkersTimeInput) dailyWorkersTimeInput.value = "480"; // Reverted to original value

            const mixingCrewTimeInput = document.getElementById('mixing_crew_time');
            if (mixingCrewTimeInput) mixingCrewTimeInput.value = "480"; // Reverted to original value

            const printerOperatorTimeInput = document.getElementById('printer_operator_time');
            if (printerOperatorTimeInput) printerOperatorTimeInput.value = "480"; // Reverted to original value

            const workersRateInput = document.getElementById('workers_rate');
            if (workersRateInput) workersRateInput.value = "31250"; // Reverted to original value

            const leaderRateInput = document.getElementById('leader_rate');
            if (leaderRateInput) leaderRateInput.value = "62500"; // Reverted to original value

            const dailyWorkersRateInput = document.getElementById('daily_workers_rate');
            if (dailyWorkersRateInput) dailyWorkersRateInput.value = "25000"; // Reverted to original value

            const mixingCrewRateInput = document.getElementById('mixing_crew_rate');
            if (mixingCrewRateInput) mixingCrewRateInput.value = "30000"; // Reverted to original value

            const printerOperatorRateInput = document.getElementById('printer_operator_rate');
            if (printerOperatorRateInput) printerOperatorRateInput.value = "40000"; // Reverted to original value


            // Ensure Firebase `db` and `auth` are initialized from the script module.
            // These are now globally available after the module script runs.
            // We need to wait for the auth state to be ready before calling loadHistory.
            window.addEventListener('authReady', () => {
                loadHistory(); // Load history after auth is confirmed ready
                const userIdDisplay = document.getElementById('user_id_display');
                if (userIdDisplay) userIdDisplay.textContent = window.getUserId();
            });

            // Set initial selected currency from the selector or default
            const currencySelector = document.getElementById('currency_selector');
            if (currencySelector) {
                selectedCurrencyCode = currencySelector.value;
            }

            renderPrinterCards();
            // Select Win Sun and its first option by default
            selectPrinter(PRINTERS[0].name, 0, 0); 
            renderMixDesignOptions(); // Render mix design options on load
            updateProjectNameForPrint();
            
            // Update colspans for all tables
            updateTotalColspan('materials_tbody');
            updateTotalColspan('equipment_tbody');
            updateTotalColspan('labor_tbody');
            
            // Update initial state of volume source control
            updateVolumeSource(); // This will also trigger calculateAll()

            // Smooth scrolling for navigation links
            document.querySelectorAll('.nav-item').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();

                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });
        });

    </script>
</body>
</html>



